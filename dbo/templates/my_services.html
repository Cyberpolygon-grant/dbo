{% extends 'base.html' %}

{% block title %}–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ - –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–±–∞–Ω–∫ "–§–∏–Ω–∞–Ω—Å–ü—Ä–æ"{% endblock %}

{% block content %}
{% csrf_token %}
<div class="min-h-screen bg-gradient-to-br from-base-100 to-base-200">
    <!-- Hero Section -->
    <div class="hero bg-gradient-to-r from-primary to-secondary text-primary-content py-16">
        <div class="hero-content text-center">
            <div class="max-w-4xl">
                <h1 class="text-5xl font-bold mb-6">–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏</h1>
                <p class="text-xl mb-8 opacity-90">
                    –£–ø—Ä–∞–≤–ª—è–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ –±–∞–Ω–∫–æ–≤—Å–∫–∏–º–∏ —É—Å–ª—É–≥–∞–º–∏
                </p>
                <div class="stats stats-horizontal bg-base-100 text-base-content shadow-lg">
                    <div class="stat">
                        <div class="stat-title">–ê–∫—Ç–∏–≤–Ω—ã—Ö —É—Å–ª—É–≥</div>
                        <div class="stat-value text-primary">{{ active_services }}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-title">–í—Å–µ–≥–æ —É—Å–ª—É–≥</div>
                        <div class="stat-value text-secondary">{{ connected_services|length }}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-title">–ï–∂–µ–º–µ—Å—è—á–Ω–∞—è –ø–ª–∞—Ç–∞</div>
                        <div class="stat-value text-accent">{{ total_monthly_fee }} ‚ÇΩ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="breadcrumbs text-sm mb-8">
            <ul>
                <li><a href="{% url 'client_dashboard' %}">–î–∞—à–±–æ—Ä–¥</a></li>
                <li><a href="{% url 'banking_services' %}">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —É—Å–ª—É–≥–∏</a></li>
                <li>–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏</li>
            </ul>
        </div>

        <!-- –£—Å–ª—É–≥–∏ -->
        {% if connected_services %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for client_service in connected_services %}
            <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 service-card" 
                 data-status="{{ client_service.status }}" 
                 data-category="{{ client_service.service.category.name }}">
                <!-- –°—Ç–∞—Ç—É—Å —É—Å–ª—É–≥–∏ -->
                <div class="card-body p-6">
                    <div class="mb-4">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-lg bg-base-200 flex items-center justify-center flex-shrink-0">
                                {% with name=client_service.service.name|lower cat=client_service.service.category.name|lower %}
                                    <span class="text-2xl select-none">
                                        {% if '–∏–Ω–≤–µ—Å—Ç' in name or '–∏–Ω–≤–µ—Å—Ç' in cat %}üìà{% elif '–∫—Ä–µ–¥–∏—Ç' in name or '–∏–ø–æ—Ç–µ–∫' in name or '–∫—Ä–µ–¥–∏—Ç' in cat %}üí≥{% elif '–¥–µ–ø–æ–∑–∏—Ç' in name or '–≤–∫–ª–∞–¥' in name or '–¥–µ–ø–æ–∑–∏—Ç' in cat %}üí∞{% elif '–∫–∞—Ä—Ç–∞' in name or '–∫–∞—Ä—Ç–∞' in cat %}üí≥{% elif '–ø–µ—Ä–µ–≤–æ–¥' in name or '–ø–ª–∞—Ç–µ–∂' in name or '–ø–ª–∞—Ç—ë–∂' in name or '–ø–µ—Ä–µ–≤–æ–¥' in cat or '–ø–ª–∞—Ç' in cat %}üîÅ{% elif '—Å—Ç—Ä–∞—Ö' in name or '—Å—Ç—Ä–∞—Ö' in cat %}üõ°Ô∏è{% elif '—Å—á–µ—Ç' in name or '—Å—á—ë—Ç' in name or '—Ä–∫–æ' in name or '—Å—á–µ—Ç' in cat %}üè¶{% elif '–∏–Ω—Ç–µ—Ä–Ω–µ—Ç' in name or '–º–æ–±–∏–ª' in name or '–æ–Ω–ª–∞–π–Ω' in name %}üì±{% elif 'vip' in name or '–ø—Ä–µ–º–∏—É–º' in name %}‚≠ê{% elif '–ø–æ–¥–¥–µ—Ä–∂' in name or '–∫–æ–Ω—Å—å–µ—Ä–∂' in name %}üë©‚Äçüíº{% else %}üß©{% endif %}
                                    </span>
                                {% endwith %}
                            </div>
                            <div class="min-w-0 flex-1">
                                <h3 class="card-title text-lg leading-tight truncate">{{ client_service.service.name }}</h3>
                                <p class="text-sm text-base-content/60 truncate">{{ client_service.service.category.name }}</p>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <div class="badge {% if client_service.status == 'active' %}badge-success{% elif client_service.status == 'suspended' %}badge-warning{% elif client_service.status == 'cancelled' %}badge-error{% else %}badge-neutral{% endif %}" style="white-space: nowrap;">
                                {% if client_service.status == 'pending' %}–í –æ–∂–∏–¥–∞–Ω–∏–∏{% else %}{{ client_service.get_status_display }}{% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                    <p class="text-base-content/70 mb-4 line-clamp-3">{{ client_service.service.description|truncatewords:15 }}</p>
                    
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö -->
                    {% if client_service.monthly_fee > 0 %}
                    <div class="alert alert-info mb-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                        <div>
                            <div class="font-semibold">{{ client_service.monthly_fee }} ‚ÇΩ/–º–µ—Å</div>
                            {% if client_service.next_payment_date %}
                            <div class="text-sm">–°–ª–µ–¥—É—é—â–∏–π –ø–ª–∞—Ç–µ–∂: {{ client_service.next_payment_date|date:"d.m.Y" }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- –î–∞—Ç–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
                    <div class="text-sm text-base-content/60 mb-4">
                        –ü–æ–¥–∫–ª—é—á–µ–Ω–∞: {{ client_service.connected_at|date:"d.m.Y" }}
                    </div>
                    
                    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                    <div class="card-actions justify-between">
                        {% if client_service.status == 'active' %}
                        <button class="btn btn-outline btn-sm flex-1" onclick="viewServiceDetails('{{ client_service.service.uuid }}')">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                        <button class="btn btn-error btn-sm flex-1" onclick="disconnectService('{{ client_service.service.uuid }}', '{{ client_service.service.name }}')">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            –û—Ç–∫–ª—é—á–∏—Ç—å
                        </button>
                        {% else %}
                        <button class="btn btn-outline btn-sm flex-1" onclick="viewServiceDetails('{{ client_service.service.uuid }}')">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                        <button class="btn btn-primary btn-sm flex-1" onclick="reconnectService('{{ client_service.service.uuid }}', '{{ client_service.service.name }}')">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            –ü–æ–¥–∫–ª—é—á–∏—Ç—å
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- –ï—Å–ª–∏ –Ω–µ—Ç —É—Å–ª—É–≥ -->
        <div class="text-center py-12">
            <div class="w-24 h-24 bg-base-300 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-12 h-12 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-base-content mb-2">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥</h3>
            <p class="text-base-content/70 mb-6">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–∞—Ç–∞–ª–æ–≥ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —É—Å–ª—É–≥, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ –≤–∞—Å —É—Å–ª—É–≥–∏.</p>
            <a href="{% url 'banking_services' %}" class="btn btn-primary btn-lg">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                –ü–µ—Ä–µ–π—Ç–∏ –∫ —É—Å–ª—É–≥–∞–º
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>

// –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π —É—Å–ª—É–≥–∏
function viewServiceDetails(serviceUuid) {
    window.location.href = `/services/${serviceUuid}/`;
}

// –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ª—É–≥–∏
function disconnectService(serviceUuid, serviceName) {
    confirmAction(
        `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å —É—Å–ª—É–≥—É "${serviceName}"?`,
        function() {
            fetch(`/disconnect-service/${serviceUuid}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', data.message);
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showToast('error', data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏');
            });
        }
    );
}

// –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ª—É–≥–∏
function reconnectService(serviceUuid, serviceName) {
    confirmAction(
        `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —É—Å–ª—É–≥—É "${serviceName}"?`,
        function() {
            fetch(`/connect-service/${serviceUuid}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', data.message);
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showToast('error', data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏');
            });
        }
    );
}

// –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showToast(type, message) {
    const toast = document.createElement('div');
    toast.className = 'toast toast-top toast-end';
    toast.style.zIndex = '9999';
    
    const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
    const iconPath = type === 'success' 
        ? 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'
        : 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z';
    
    toast.innerHTML = `
        <div class="alert ${alertClass}">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"></path>
            </svg>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

</script>
{% endblock %}
