{% extends "base.html" %}

{% block title %}–î–µ–ø–æ–∑–∏—Ç–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div class="hero bg-gradient-to-r from-info to-success text-primary-content rounded-lg mb-8">
        <div class="hero-content text-center">
            <div class="max-w-md">
                <h1 class="text-4xl font-bold mb-4">–î–µ–ø–æ–∑–∏—Ç–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</h1>
                <p class="text-lg opacity-90">–í—ã–≥–æ–¥–Ω—ã–µ –¥–µ–ø–æ–∑–∏—Ç—ã —Å –≤—ã—Å–æ–∫–∏–º–∏ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–º–∏ —Å—Ç–∞–≤–∫–∞–º–∏ –∏ –≥–∏–±–∫–∏–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏</p>
                <div class="badge badge-lg badge-accent mt-4">–î–æ 8.5% –≥–æ–¥–æ–≤—ã—Ö</div>
                <div class="mt-4 text-sm opacity-90" id="pageQuote">–ò–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ ‚Äî —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –¥–µ–ª–∞—é—Ç —Å–≤–æ—ë –¥–µ–ª–æ.</div>
            </div>
        </div>
    </div>

    <!-- –ï–¥–∏–Ω–∞—è —Ñ–æ—Ä–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≤–∫–ª–∞–¥–∞ –ø–æ —Ç–∞—Ä–∏—Ñ—É -->
    <div class="card bg-base-100 shadow-xl mb-8">
        <div class="card-body">
            <h2 class="card-title text-2xl mb-4">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∞</h2>
            <form id="unifiedDepositForm" method="POST" action="{% url 'create_deposit_request' %}">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div class="form-control mb-5">
                            <label class="label"><span class="label-text">–¢–∞—Ä–∏—Ñ –≤–∫–ª–∞–¥–∞</span></label>
                            <div class="grid grid-cols-2 gap-3" id="tariffGroup">
                                <div class="card bg-base-200 border-2 border-transparent hover:border-primary cursor-pointer transition-all" data-tariff="t6_70">
                                    <div class="card-body p-4">
                                        <h3 class="font-bold text-sm">–°—Ç–∞–Ω–¥–∞—Ä—Ç 6</h3>
                                        <div class="text-2xl font-bold text-primary">7.0%</div>
                                        <div class="text-xs opacity-70">6 –º–µ—Å</div>
                                        <div class="text-xs opacity-70">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ: –Ω–µ—Ç</div>
                                        <div class="badge badge-sm badge-outline mt-2">–ë–∞–∑–æ–≤—ã–π</div>
                                    </div>
                                </div>
                                <div class="card bg-base-200 border-2 border-transparent hover:border-success cursor-pointer transition-all" data-tariff="t12_80">
                                    <div class="card-body p-4">
                                        <h3 class="font-bold text-sm">–ù–∞–¥–µ–∂–Ω—ã–π 12</h3>
                                        <div class="text-2xl font-bold text-success">8.0%</div>
                                        <div class="text-xs opacity-70">12 –º–µ—Å</div>
                                        <div class="text-xs opacity-70">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ: –Ω–µ—Ç</div>
                                        <div class="badge badge-sm badge-success mt-2">–í—ã–≥–æ–¥–Ω—ã–π</div>
                                    </div>
                                </div>
                                <div class="card bg-base-200 border-2 border-transparent hover:border-accent cursor-pointer transition-all" data-tariff="t24_85">
                                    <div class="card-body p-4">
                                        <h3 class="font-bold text-sm">–ú–∞–∫—Å–∏–º—É–º 24</h3>
                                        <div class="text-2xl font-bold text-accent">8.5%</div>
                                        <div class="text-xs opacity-70">24 –º–µ—Å</div>
                                        <div class="text-xs opacity-70">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ: –Ω–µ—Ç</div>
                                        <div class="badge badge-sm badge-accent mt-2">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π</div>
                                    </div>
                                </div>
                                <div class="card bg-base-200 border-2 border-transparent hover:border-info cursor-pointer transition-all" data-tariff="r12_75">
                                    <div class="card-body p-4">
                                        <h3 class="font-bold text-sm">–ü–æ–ø–æ–ª–Ω—è–µ–º—ã–π 12</h3>
                                        <div class="text-2xl font-bold text-info">7.5%</div>
                                        <div class="text-xs opacity-70">12 –º–µ—Å</div>
                                        <div class="text-xs opacity-70">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ: –¥–∞</div>
                                        <div class="badge badge-sm badge-info mt-2">–ì–∏–±–∫–∏–π</div>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="tariff" id="selectedTariff" value="t6_70">
                            <label class="label"><span class="label-text-alt">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–∞—Ä–∏—Ñ ‚Äî —Ä–∞—Å—á—ë—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span></label>
                        </div>

                        <div class="form-control mb-5">
                            <label class="label"><span class="label-text">–°—É–º–º–∞ –≤–∫–ª–∞–¥–∞</span></label>
                            <div class="relative">
                                <input id="uAmount" type="range" min="10000" max="5000000" step="10000" value="100000" class="range range-primary w-full">
                                <input type="hidden" name="amount" id="uAmountHidden" value="100000">
                                <div class="flex justify-between text-sm px-2 mt-2">
                                    <span class="text-gray-500">10 000 ‚ÇΩ</span>
                                    <span class="font-bold text-primary text-lg" id="uAmountOut">100 000 ‚ÇΩ</span>
                                    <span class="text-gray-500">5 000 000 ‚ÇΩ</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="card bg-base-100 shadow">
                            <div class="card-body">
                                <h4 class="card-title text-xl">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏—Ç–æ–≥</h4>
                                <div class="grid grid-cols-2 gap-4 items-center">
                                <div class="text-lg">
                                    <div class="mb-3">–°—É–º–º–∞: <span class="font-bold text-xl" id="uPrevAmount">100 000 ‚ÇΩ</span></div>
                                    <div class="mb-3">–°—Ä–æ–∫: <span class="font-bold text-xl" id="uPrevTerm">6 –º–µ—Å</span></div>
                                    <div class="mb-3">–°—Ç–∞–≤–∫–∞: <span class="font-bold text-xl" id="uPrevRate">7.0%</span></div>
                                    <div class="mb-3">–î–æ—Ö–æ–¥: <span class="text-success font-bold text-xl" id="uPrevIncome">‚Äî ‚ÇΩ</span></div>
                                    <div class="text-base opacity-70 mt-2">–ö –¥–∞—Ç–µ: <span id="uPrevMaturity">‚Äî</span></div>
                                </div>
                                    <div class="text-sm opacity-70" id="uTip">–¢–∞—Ä–∏—Ñ –º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å ‚Äî —Å—Ç–∞–≤–∫–∞ –∏ —Å—Ä–æ–∫ –æ–±–Ω–æ–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center justify-end gap-2 mt-6">
                            <button type="submit" class="btn btn-primary">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    

    

    <!-- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-2xl mb-6">–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–∞—à–∏—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-3xl mb-2">üí∞</div>
                    <h3 class="font-semibold mb-1">–í—ã—Å–æ–∫–∏–µ —Å—Ç–∞–≤–∫–∏</h3>
                    <p class="text-sm text-base-content/70">–î–æ 8.5% –≥–æ–¥–æ–≤—ã—Ö</p>
                </div>
                <div class="text-center">
                    <div class="text-3xl mb-2">üîí</div>
                    <h3 class="font-semibold mb-1">–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å</h3>
                    <p class="text-sm text-base-content/70">–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –≤–∫–ª–∞–¥–æ–≤</p>
                </div>
                <div class="text-center">
                    <div class="text-3xl mb-2">üì±</div>
                    <h3 class="font-semibold mb-1">–£–¥–æ–±—Å—Ç–≤–æ</h3>
                    <p class="text-sm text-base-content/70">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–Ω–ª–∞–π–Ω</p>
                </div>
                <div class="text-center">
                    <div class="text-3xl mb-2">‚ö°</div>
                    <h3 class="font-semibold mb-1">–ë—ã—Å—Ç—Ä–æ</h3>
                    <p class="text-sm text-base-content/70">–û—Ç–∫—Ä—ã—Ç–∏–µ –∑–∞ 5 –º–∏–Ω—É—Ç</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–µ–ø–æ–∑–∏—Ç–∞ -->
<div id="depositModal" class="modal">
    <div class="modal-box max-w-4xl">
        <h3 class="font-bold text-xl mb-2" id="depositModalTitle">–û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞</h3>
        <p class="text-base-content/70 mb-6">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</p>
        <form id="depositForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="form-control mb-5">
                        <label class="label"><span class="label-text">–¢–∏–ø –¥–µ–ø–æ–∑–∏—Ç–∞</span></label>
                        <div class="filter w-full">
                            <input class="btn" type="radio" name="deposit_type" value="term" aria-label="–°—Ä–æ—á–Ω—ã–π" required>
                            <input class="btn" type="radio" name="deposit_type" value="replenishable" aria-label="–ü–æ–ø–æ–ª–Ω—è–µ–º—ã–π">
                        </div>
                        <label class="label"><span class="label-text-alt">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø—Ä–æ–¥—É–∫—Ç</span></label>
            </div>

                    <div class="form-control mb-5">
                        <label class="label"><span class="label-text">–°—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞</span></label>
                        <div class="relative">
                            <input id="depAmountRange" type="range" min="10000" max="5000000" step="10000" value="100000" class="range range-primary w-full">
                            <div class="flex justify-between text-sm px-2 mt-2">
                                <span class="text-gray-500">10 000 ‚ÇΩ</span>
                                <span class="font-bold text-primary text-lg" id="depAmountValue">100 000 ‚ÇΩ</span>
                                <span class="text-gray-500">5 000 000 ‚ÇΩ</span>
                            </div>
                        </div>
                        <input type="hidden" name="amount" id="depAmountHidden" value="100000">
                    </div>

                </div>

                <div>
                    <div class="form-control mb-5">
                        <label class="label"><span class="label-text">–°—Ä–æ–∫ –¥–µ–ø–æ–∑–∏—Ç–∞</span></label>
                        <div class="join w-full">
                            <input class="btn join-item" type="radio" name="term" value="6" aria-label="6 –º–µ—Å" required>
                            <input class="btn join-item" type="radio" name="term" value="12" aria-label="12 –º–µ—Å" checked>
                            <input class="btn join-item" type="radio" name="term" value="24" aria-label="24 –º–µ—Å">
                            <input class="btn join-item" type="radio" name="term" value="36" aria-label="36 –º–µ—Å">
                        </div>
                    </div>

                    <div class="card bg-base-100 shadow">
                        <div class="card-body">
                            <h4 class="card-title text-xl">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏—Ç–æ–≥</h4>
                            <div class="grid grid-cols-2 gap-4 items-center">
                                <div class="text-lg">
                                    <div class="mb-3">–°—É–º–º–∞: <span class="font-bold text-xl" id="depPreviewAmount">100 000 ‚ÇΩ</span></div>
                                    <div class="mb-3">–°—Ä–æ–∫: <span class="font-bold text-xl" id="depPreviewTerm">12 –º–µ—Å</span></div>
                                    <div class="mb-3">–°—Ç–∞–≤–∫–∞: <span class="font-bold text-xl" id="depPreviewRate">‚Äî%</span></div>
                                    <div class="mb-3">–î–æ—Ö–æ–¥: <span class="text-success font-bold text-xl" id="depPreviewIncome">‚Äî ‚ÇΩ</span></div>
                                    <div class="text-base opacity-70 mt-2">–ö –¥–∞—Ç–µ: <span id="depPreviewMaturity">‚Äî</span></div>
                                </div>
                                <div class="flex flex-col items-center w-full">
                                    <svg id="depPreviewChart" viewBox="0 0 240 100" class="w-full h-24 bg-base-200 rounded text-primary">
                                        <g id="depPreviewDots"></g>
                                    </svg>
                                    <div class="w-full h-2 rounded-full bg-base-200 mt-3 overflow-hidden">
                                        <div id="depStackIncome" class="h-2 bg-success" style="width:0%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-soft alert-info mt-3 p-2 text-sm" id="depTip">–°–æ–≤–µ—Ç –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Å—É–º–º—ã –∏ —Å—Ä–æ–∫–∞.</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-end gap-2 mt-6">
                <button type="button" class="btn btn-ghost" onclick="closeDepositModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
            </div>
        </form>
    </div>
</div>

<script>
function openDepositModal(type) {
    const modal = document.getElementById('depositModal');
    const title = document.getElementById('depositModalTitle');
    const typeInputs = document.querySelectorAll('input[name="deposit_type"]');
    
    switch(type) {
        case 'term':
            title.textContent = '–û—Ç–∫—Ä—ã—Ç–∏–µ —Å—Ä–æ—á–Ω–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞';
            typeInputs.forEach(i => { if (i.value === 'term') i.checked = true; });
            break;
        case 'replenishable':
            title.textContent = '–û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–ø–æ–ª–Ω—è–µ–º–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞';
            typeInputs.forEach(i => { if (i.value === 'replenishable') i.checked = true; });
            break;
    }
    
    // –ï—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    const sel = document.querySelector('input[name="deposit_type"]:checked');
    if (!sel && typeInputs.length) {
        typeInputs[0].checked = true;
    }

    // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É, –∑–∞—Ç–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    modal.classList.add('modal-open');
    try {
        if (typeof updateDepositPreview === 'function') {
            updateDepositPreview();
        }
    } catch(e) {}
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ —Å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Ç–∞—Ä–∏—Ñ–æ–º
function openDepositWithTariff(code) {
    // –∫–æ–¥ –≤–∏–¥–∞ t6_70 (term 6 –º–µ—Å, 7.0%), t24_85, r12_75 (replenishable)
    const map = {
        't6_70': { type: 'term', term: 6, rate: 7.0 },
        't12_80': { type: 'term', term: 12, rate: 8.0 },
        't24_85': { type: 'term', term: 24, rate: 8.5 },
        'r12_75': { type: 'replenishable', term: 12, rate: 7.5 },
    };
    const t = map[code] || map['t12_80'];
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–æ–∫ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
    openDepositModal(t.type === 'term' ? 'term' : 'replenishable');
    setTimeout(() => {
        try {
            const termInput = document.querySelector(`input[name="term"][value="${t.term}"]`);
            if (termInput) { termInput.checked = true; }
            window.__fixedTariffRate = t.rate;
            updateDepositPreview();
        } catch(e) {}
    }, 0);
}

// –õ–æ–≥–∏–∫–∞ –¥–ª—è –µ–¥–∏–Ω–æ–π —Ñ–æ—Ä–º—ã –¥–µ–ø–æ–∑–∏—Ç–æ–≤
(function() {
    const amountSlider = document.getElementById('uAmount');
    const amountOut = document.getElementById('uAmountOut');
    const tariffCards = document.querySelectorAll('[data-tariff]');
    const selectedTariffInput = document.getElementById('selectedTariff');
    
    const tariffMap = {
        't6_70': { term: 6, rate: 7.0, name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç 6', color: 'primary', badge: '–ë–∞–∑–æ–≤—ã–π' },
        't12_80': { term: 12, rate: 8.0, name: '–ù–∞–¥–µ–∂–Ω—ã–π 12', color: 'success', badge: '–í—ã–≥–æ–¥–Ω—ã–π' },
        't24_85': { term: 24, rate: 8.5, name: '–ú–∞–∫—Å–∏–º—É–º 24', color: 'accent', badge: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π' },
        'r12_75': { term: 12, rate: 7.5, name: '–ü–æ–ø–æ–ª–Ω—è–µ–º—ã–π 12', color: 'info', badge: '–ì–∏–±–∫–∏–π' }
    };
    
    function selectTariff(tariffCode) {
        // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
        tariffCards.forEach(card => {
            card.classList.remove('border-primary', 'border-success', 'border-accent', 'border-info', 'ring-2');
            card.classList.add('border-transparent');
        });
        
        // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
        const selectedCard = document.querySelector(`[data-tariff="${tariffCode}"]`);
        if (selectedCard) {
            const tariff = tariffMap[tariffCode];
            selectedCard.classList.remove('border-transparent');
            selectedCard.classList.add(`border-${tariff.color}`, 'ring-2');
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
        if (selectedTariffInput) {
            selectedTariffInput.value = tariffCode;
        }
        
        updateUnifiedPreview();
    }
    
    function updateUnifiedPreview() {
        const amount = Number(amountSlider?.value || 100000);
        const tariffCode = selectedTariffInput?.value || 't6_70';
        const tariff = tariffMap[tariffCode];
        
        if (!tariff) return;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—É–º–º—ã
        if (amountOut) {
            amountOut.textContent = Math.round(amount).toLocaleString('ru-RU') + ' ‚ÇΩ';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        const amountHidden = document.getElementById('uAmountHidden');
        if (amountHidden) {
            amountHidden.value = Math.round(amount);
        }
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–æ—Ö–æ–¥
        const income = amount * tariff.rate / 100 * tariff.term / 12;
        const total = amount + income;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏—Ç–æ–≥
        const prevAmount = document.getElementById('uPrevAmount');
        const prevTerm = document.getElementById('uPrevTerm');
        const prevRate = document.getElementById('uPrevRate');
        const prevIncome = document.getElementById('uPrevIncome');
        const prevMaturity = document.getElementById('uPrevMaturity');
        const tip = document.getElementById('uTip');
        
        if (prevAmount) prevAmount.textContent = Math.round(amount).toLocaleString('ru-RU') + ' ‚ÇΩ';
        if (prevTerm) prevTerm.textContent = tariff.term + ' –º–µ—Å';
        if (prevRate) prevRate.textContent = tariff.rate.toFixed(1) + '%';
        if (prevIncome) prevIncome.textContent = Math.round(income).toLocaleString('ru-RU') + ' ‚ÇΩ';
        
        // –î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è
        if (prevMaturity) {
            const today = new Date();
            const maturity = new Date(today.getFullYear(), today.getMonth() + tariff.term, today.getDate());
            prevMaturity.textContent = maturity.toLocaleDateString('ru-RU');
        }
        
        // –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π
        if (tip) {
            let message = `–¢–∞—Ä–∏—Ñ "${tariff.name}" –≤—ã–±—Ä–∞–Ω. –°—Ç–∞–≤–∫–∞ ${tariff.rate}% –Ω–∞ ${tariff.term} –º–µ—Å.`;
            if (tariff.rate >= 8.0) {
                message += ' üü¢ –í—ã—Å–æ–∫–∞—è —Å—Ç–∞–≤–∫–∞ ‚Äî –æ—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä!';
            } else if (tariff.rate >= 7.5) {
                message += ' üü° –•–æ—Ä–æ—à–∞—è —Å—Ç–∞–≤–∫–∞ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏.';
            } else {
                message += ' üî¥ –ë–∞–∑–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ ‚Äî —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –±–æ–ª–µ–µ –≤—ã–≥–æ–¥–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã.';
            }
            
            if (amount >= 1000000) message += ' –ö—Ä—É–ø–Ω–∞—è —Å—É–º–º–∞ ‚Äî –º–∞–∫—Å–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –¥–æ—Ö–æ–¥!';
            else if (amount < 50000) message += ' –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—É–º–º—ã –¥–ª—è –±–æ–ª—å—à–µ–≥–æ –¥–æ—Ö–æ–¥–∞.';
            
            tip.textContent = message;
        }
    }
    
    // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
    if (amountSlider) {
        amountSlider.addEventListener('input', updateUnifiedPreview);
    }
    
    tariffCards.forEach(card => {
        card.addEventListener('click', function() {
            const tariffCode = this.getAttribute('data-tariff');
            selectTariff(tariffCode);
        });
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    selectTariff('t6_70');
    updateUnifiedPreview();
})();

// Live calculator logic
(function(){
    const amt = document.getElementById('calcAmount');
    const term = document.getElementById('calcTerm');
    const rate = document.getElementById('calcRate');
    const capInputs = document.querySelectorAll('input[name="calcCap"]');
    const tip = document.getElementById('calcTip');

    function readCap() {
        const s = document.querySelector('input[name="calcCap"]:checked');
        return s ? s.value : 'monthly';
    }

    function fmtMoney(n){ return Math.round(n).toLocaleString('ru-RU') + ' ‚ÇΩ'; }

    function recalc() {
        const A = Number(amt.value||0);
        const T = Number(term.value||0);
        const R = Number(rate.value||0);
        if (A<=0 || T<=0 || R<=0) return;
        const cap = readCap();
        let total, income, eff;
        const rMonthly = R/100/12;
        if (cap === 'monthly') {
            total = A*Math.pow(1+rMonthly, T);
            income = total - A;
            eff = (Math.pow(1+rMonthly, 12)-1)*100;
        } else if (cap === 'quarterly') {
            const rQ = R/100/4; const Q = Math.ceil(T/3);
            total = A*Math.pow(1+rQ, Q);
            income = total - A; eff = (Math.pow(1+rQ,4)-1)*100;
        } else if (cap === 'yearly') {
            const rY = R/100; const Y = T/12;
            total = A*Math.pow(1+rY, Y);
            income = total - A; eff = R;
        } else {
            income = A*R/100*T/12; total = A+income; eff = R;
        }
        // outputs
        document.getElementById('calcAmountOut').textContent = fmtMoney(A);
        document.getElementById('calcTermOut').textContent = T.toString();
        document.getElementById('calcRateOut').textContent = R.toFixed(1)+'%';
        document.getElementById('calcTotal').textContent = fmtMoney(total);
        document.getElementById('calcIncome').textContent = fmtMoney(income);
        document.getElementById('calcEff').textContent = eff.toFixed(2)+'%';
        const mEl = document.getElementById('calcMonthly');
        if (mEl) mEl.textContent = fmtMoney(income/Math.max(1,T));
        const share = Math.min(100, Math.max(0, (income/total)*100));
        const rp = document.getElementById('calcProgress');
        rp.style.setProperty('--value', share.toFixed(0));
        rp.textContent = share.toFixed(0)+'%';
        const bar = document.getElementById('calcStackIncome');
        if (bar) bar.style.width = share.toFixed(0)+'%';

        // simple SVG line chart of growth
        const dotsGroup = document.getElementById('calcDots');
        if (dotsGroup) {
            const w = 300, h = 120, pad = 10;
            const steps = Math.min(T, 24);
            dotsGroup.innerHTML = '';
            const incPer = income/steps;
            for (let i=0;i<=steps;i++) {
                const x = pad + (w-2*pad) * (i/steps);
                const val = A + incPer*i;
                const y = h - pad - (h-2*pad) * ((val - A) / Math.max(1, income));
                const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
                c.setAttribute('cx', x.toFixed(1));
                c.setAttribute('cy', y.toFixed(1));
                c.setAttribute('r', '3');
                c.setAttribute('fill', 'hsl(var(--p))');
                c.setAttribute('opacity', i===0||i===steps ? '0.9' : '0.7');
                dotsGroup.appendChild(c);
            }
        }

        // schedule
        const sch = document.getElementById('calcSchedule');
        sch.innerHTML = '';
        const steps = Math.min(T, 24); // –æ–≥—Ä–∞–Ω–∏—á–∏–º –¥–æ 24 –∑–∞–ø–∏—Å–µ–π
        let base = A; const incPer = income/steps;
        for (let i=1;i<=steps;i++){
            const li = document.createElement('div');
            li.className = 'list-row flex items-center justify-between';
            const monthLabel = (i===T? '–ò—Ç–æ–≥' : `–ú–µ—Å—è—Ü ${i}`);
            base += incPer;
            li.innerHTML = `<span>${monthLabel}</span><span class="font-mono">${fmtMoney(base)}</span>`;
            sch.appendChild(li);
        }

        // smart tip
        if (tip) {
            let message = '–ü–æ–¥–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ ‚Äî –∏–Ω–æ–≥–¥–∞ +6 –º–µ—Å –∑–∞–º–µ—Ç–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç –¥–æ—Ö–æ–¥.';
            if (T < 12 && R < 7) message = '–ù–µ–±–æ–ª—å—à–æ–π —Å—Ä–æ–∫ –∏ –Ω–∏–∑–∫–∞—è —Å—Ç–∞–≤–∫–∞ ‚Äî —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ —Å—Ä–æ–∫–∞ –∏–ª–∏ —Å—Ç–∞–≤–∫–∏.';
            else if (A >= 1000000) message = '–ö—Ä—É–ø–Ω–∞—è —Å—É–º–º–∞ ‚Äî –¥–∞–∂–µ +0.5% –¥–∞—Å—Ç –æ—â—É—Ç–∏–º—ã–π –ø—Ä–∏—Ä–æ—Å—Ç –¥–æ—Ö–æ–¥–∞.';
            else if (T >= 24) message = '–î–ª–∏–Ω–Ω—ã–π —Å—Ä–æ–∫: —ç—Ñ—Ñ–µ–∫—Ç —Å–ª–æ–∂–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏–ª—å–Ω–µ–µ.';
            tip.textContent = message;
        }
    }

    ['input','change'].forEach(ev=>{
        amt?.addEventListener(ev,recalc);
        term?.addEventListener(ev,recalc);
        rate?.addEventListener(ev,recalc);
        capInputs.forEach(r=>r.addEventListener(ev,recalc));
    });

    recalc();
})();

function closeDepositModal() {
    document.getElementById('depositModal').classList.remove('modal-open');
}

function viewDepositDetails(depositId) {
    showAlert('–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π –¥–µ–ø–æ–∑–∏—Ç–∞ #' + depositId, 'info');
}

function replenishDeposit(depositId) {
    showAlert('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞ #' + depositId, 'info');
}

function calculateDeposit() {
    // replaced by live calculator; keep function as no-op for backward compatibility
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–µ–ø–æ–∑–∏—Ç–∞
// –ñ–∏–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—É–º–º—ã –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
document.getElementById('depAmountRange')?.addEventListener('input', function() {
    const v = Number(this.value || 0);
    document.getElementById('depAmountValue').textContent = v.toLocaleString('ru-RU') + ' ‚ÇΩ';
    document.getElementById('depPreviewAmount').textContent = v.toLocaleString('ru-RU') + ' ‚ÇΩ';
    document.getElementById('depAmountHidden').value = String(v);
    updateDepositPreview();
});

document.querySelectorAll('input[name="term"]').forEach(r => {
    r.addEventListener('change', function() {
        document.getElementById('depPreviewTerm').textContent = this.value + ' –º–µ—Å';
        updateDepositPreview();
    });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –µ–¥–∏–Ω–æ–π —Ñ–æ—Ä–º—ã –¥–µ–ø–æ–∑–∏—Ç–æ–≤
// –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º, Django messages –æ–±—Ä–∞–±–æ—Ç–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

// –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏—Ç–æ–≥–æ–≤ —Ñ–æ—Ä–º—ã –¥–µ–ø–æ–∑–∏—Ç–∞
function updateDepositPreview() {
    const amount = Number(document.getElementById('depAmountHidden').value || 0);
    const termInput = document.querySelector('input[name="term"]:checked');
    const term = termInput ? Number(termInput.value) : 12;
    const typeInput = document.querySelector('input[name="deposit_type"]:checked');
    const type = typeInput ? typeInput.value : 'term';
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å—É–º–º–∞ –∏ —Å—Ä–æ–∫ –≤ –±–ª–æ–∫–µ –∏—Ç–æ–≥–∞
    const amtOut = document.getElementById('depPreviewAmount');
    if (amtOut) amtOut.textContent = Math.round(amount).toLocaleString('ru-RU') + ' ‚ÇΩ';
    const termOut = document.getElementById('depPreviewTerm');
    if (termOut) termOut.textContent = term + ' –º–µ—Å';
    // –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ —Å—Ç–∞–≤–∫–∏: –±–æ–ª—å—à–µ —Å—É–º–º–∞/—Å—Ä–æ–∫ ‚Äî –≤—ã—à–µ —Å—Ç–∞–≤–∫–∞
    let baseRate = typeof window.__fixedTariffRate === 'number' ? window.__fixedTariffRate : (type === 'term' ? 8.0 : 7.5);
    if (amount >= 1000000) baseRate += 0.5;
    if (term >= 24) baseRate += 0.5;
    const income = amount * baseRate / 100 * term / 12;
    const total = amount + income;
    const share = Math.min(100, Math.max(0, (income/total)*100));
    document.getElementById('depPreviewRate').textContent = baseRate.toFixed(1) + '%';
    document.getElementById('depPreviewIncome').textContent = Math.round(income).toLocaleString('ru-RU') + ' ‚ÇΩ';
    const bar = document.getElementById('depStackIncome');
    if (bar) bar.style.width = share.toFixed(0) + '%';
    // –û–±–Ω–æ–≤–∏–º –º–∞–ª–µ–Ω—å–∫–∏–π –ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
    const dotsGroup = document.getElementById('depPreviewDots');
    if (dotsGroup) {
        const w = 240, h = 100, pad = 8;
        const steps = Math.min(term, 24);
        dotsGroup.innerHTML = '';
        const incPer = income/Math.max(1, steps);
        for (let i=0;i<=steps;i++) {
            const x = pad + (w-2*pad) * (i/Math.max(1,steps));
            const val = amount + incPer*i;
            const y = h - pad - (h-2*pad) * ((val - amount) / Math.max(1, income));
            const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
            c.setAttribute('cx', x.toFixed(1));
            c.setAttribute('cy', y.toFixed(1));
            c.setAttribute('r', '2.5');
            c.setAttribute('fill', 'hsl(var(--p))');
            c.setAttribute('opacity', i===0||i===steps ? '0.9' : '0.7');
            dotsGroup.appendChild(c);
        }
    }
    // –¥–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è
    const today = new Date();
    const maturity = new Date(today.getFullYear(), today.getMonth()+term, today.getDate());
    document.getElementById('depPreviewMaturity').textContent = maturity.toLocaleDateString('ru-RU');

    // smart tip for modal
    const tip = document.getElementById('depTip');
    if (tip) {
        let message = '–°–æ–≤–µ—Ç: —É–≤–µ–ª–∏—á—å—Ç–µ —Å—É–º–º—É –∏–ª–∏ —Å—Ä–æ–∫ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –¥–æ—Ö–æ–¥–∞.';
        if (amount < 50000) message = '–ù–µ–±–æ–ª—å—à–∞—è —Å—É–º–º–∞ ‚Äî —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–æ 100 000 ‚ÇΩ –¥–ª—è –æ—â—É—Ç–∏–º–æ–≥–æ –¥–æ—Ö–æ–¥–∞.';
        else if (term < 12) message = '–ö–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –º–µ—Å—è—Ü—ã –¥–ª—è –±–æ–ª—å—à–µ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞ —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤.';
        else if (amount >= 1000000 && term >= 24) message = '–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä: –∫—Ä—É–ø–Ω–∞—è —Å—É–º–º–∞ –∏ –¥–ª–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ä–æ–∫ –º–∞–∫—Å–∏–º–∏–∑–∏—Ä—É—é—Ç –¥–æ—Ö–æ–¥.';
        tip.textContent = message;
    }
}

document.querySelectorAll('input[name="deposit_type"]').forEach(r => r.addEventListener('change', updateDepositPreview));
document.addEventListener('DOMContentLoaded', updateDepositPreview);
// –ù–∞ —Å–ª—É—á–∞–π –ø–æ–∑–¥–Ω–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ DOM-—É–∑–ª–æ–≤ –≤ –º–æ–¥–∞–ª–∫–µ ‚Äì –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤
setTimeout(() => { try { updateDepositPreview(); } catch(e){} }, 300);
// –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ñ–æ—Ä–º—É: –ª—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç –∏—Ç–æ–≥
document.getElementById('depositForm')?.addEventListener('input', function(){ try{ updateDepositPreview(); }catch(e){} });
document.getElementById('depositForm')?.addEventListener('change', function(){ try{ updateDepositPreview(); }catch(e){} });
</script>

<style>
/* –£–ª—É—á—à–µ–Ω–Ω—ã–π –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ —Å–ª–∞–π–¥–µ—Ä–∞ */
.range {
    height: 6px;
}
.range::-webkit-slider-thumb {
    width: 20px;
    height: 20px;
}
.range::-moz-range-thumb {
    width: 20px;
    height: 20px;
}
</style>
{% endblock %}