# Система Дистанционного Банковского Обслуживания (ДБО)
## Техническая документация

---

**Версия:** 1.0  
**Дата:** 2024  
**Автор:** Система ДБО "ФинансПро"  
**Статус:** Активная разработка  

---

## Содержание

1. [Обзор системы](#обзор-системы)
2. [Архитектура](#архитектура)
3. [Модели данных](#модели-данных)
4. [API и эндпоинты](#api-и-эндпоинты)
5. [Безопасность](#безопасность)
6. [Установка и настройка](#установка-и-настройка)
7. [Администрирование](#администрирование)
8. [Тестирование](#тестирование)
9. [Развертывание](#развертывание)

---

## Обзор системы

### Описание

Система Дистанционного Банковского Обслуживания (ДБО) "ФинансПро" представляет собой современную веб-платформу для управления банковскими услугами онлайн. Система построена на Django и предоставляет полный спектр банковских операций через веб-интерфейс.

### Основные возможности

- **Управление клиентами**: Регистрация, верификация и управление клиентскими данными
- **Банковские услуги**: Каталог услуг с возможностью подключения и управления
- **Финансовые операции**: Переводы, платежи, депозиты, кредиты
- **Инвестиционные продукты**: Управление инвестиционными портфелями
- **Безопасность**: Многоуровневая система безопасности с логированием атак
- **Администрирование**: Панели управления для операторов и администраторов

### Технологический стек

- **Backend**: Django 5.2.7, Python 3.13
- **Database**: SQLite (разработка), PostgreSQL (продакшн)
- **Frontend**: HTML5, CSS3, JavaScript, daisyUI 5
- **Стилизация**: Tailwind CSS 4
- **Безопасность**: Django Security Framework

---

## Архитектура

### Общая архитектура

Система построена по принципу MVC (Model-View-Controller) с использованием Django Framework:

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Django Views  │    │   Models        │
│   (Templates)   │◄──►│   (Controllers) │◄──►│   (Database)    │
│   daisyUI +     │    │                 │    │                 │
│   Tailwind CSS  │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Static Files  │    │   URL Routing  │    │   Migrations    │
│   (CSS/JS)      │    │   (URLs)       │    │   (Schema)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Компоненты системы

#### 1. Модели данных (Models)
- **Operator**: Операторы ДБО (два типа)
- **Client**: Клиенты банка
- **Service**: Банковские услуги
- **ServiceCategory**: Категории услуг
- **BankCard**: Банковские карты
- **Transaction**: Финансовые транзакции
- **Deposit**: Депозитные продукты
- **Credit**: Кредитные продукты
- **InvestmentProduct**: Инвестиционные продукты
- **PhishingEmail**: Фишинговые письма (для тестирования)
- **AttackLog**: Логи атак

#### 2. Представления (Views)
- **home**: Главная страница
- **banking_services**: Каталог услуг
- **client_dashboard**: Панель клиента
- **operator1_dashboard**: Панель оператора ДБО #1
- **operator2_dashboard**: Панель оператора ДБО #2
- **create_client**: Создание клиентов
- **review_service_request**: Рассмотрение заявок

#### 3. Шаблоны (Templates)
- **base.html**: Базовый шаблон
- **index.html**: Главная страница
- **dashboard.html**: Дашборды
- **banking_services.html**: Каталог услуг
- **login.html**: Авторизация

---

## Модели данных

### Основные модели

#### Operator (Операторы ДБО)
```python
class Operator(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    operator_type = models.CharField(max_length=50, choices=[
        ('client_service', 'Оператор ДБО #1 (Отдел клиентского обслуживания)'),
        ('security', 'Оператор ДБО #2 (Отдел безопасности/валидации)'),
    ])
    email = models.EmailField()
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
```

**Назначение**: Управление операторами системы с разделением ролей.

#### Client (Клиенты)
```python
class Client(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    client_id = models.CharField(max_length=20, unique=True)
    full_name = models.CharField(max_length=200)
    email = models.EmailField()
    phone = models.CharField(max_length=20, unique=True)
    is_active = models.BooleanField(default=True)
    primary_card = models.ForeignKey('BankCard', on_delete=models.SET_NULL, null=True, blank=True)
    created_by = models.ForeignKey(Operator, on_delete=models.SET_NULL, null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
```

**Назначение**: Хранение информации о клиентах банка.

#### Service (Услуги)
```python
class Service(models.Model):
    name = models.CharField(max_length=200)
    description = models.TextField()
    category = models.ForeignKey(ServiceCategory, on_delete=models.CASCADE)
    price = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    is_active = models.BooleanField(default=True)
    is_public = models.BooleanField(default=True)
    is_privileged = models.BooleanField(default=False)
    rating = models.DecimalField(max_digits=3, decimal_places=2, default=0)
    rating_count = models.PositiveIntegerField(default=0)
    created_at = models.DateTimeField(auto_now_add=True)
```

**Назначение**: Каталог банковских услуг с возможностью публичных и привилегированных услуг.

#### BankCard (Банковские карты)
```python
class BankCard(models.Model):
    client = models.ForeignKey(Client, on_delete=models.CASCADE, related_name='cards')
    card_number = models.CharField(max_length=19)
    card_type = models.CharField(max_length=20, choices=[
        ('debit', 'Дебетовая'),
        ('credit', 'Кредитная'),
        ('prepaid', 'Предоплаченная'),
    ])
    balance = models.DecimalField(max_digits=15, decimal_places=2, default=0)
    currency = models.CharField(max_length=3, default='RUB')
    expiry_date = models.DateField()
    is_active = models.BooleanField(default=True)
    daily_limit = models.DecimalField(max_digits=10, decimal_places=2, default=100000)
    created_at = models.DateTimeField(auto_now_add=True)
```

**Назначение**: Управление банковскими картами клиентов.

#### Transaction (Транзакции)
```python
class Transaction(models.Model):
    from_card = models.ForeignKey(BankCard, on_delete=models.CASCADE, related_name='outgoing_transactions', null=True, blank=True)
    to_card = models.ForeignKey(BankCard, on_delete=models.CASCADE, related_name='incoming_transactions', null=True, blank=True)
    amount = models.DecimalField(max_digits=15, decimal_places=2)
    currency = models.CharField(max_length=3, default='RUB')
    transaction_type = models.CharField(max_length=20, choices=[
        ('transfer', 'Перевод'),
        ('payment', 'Платеж'),
        ('deposit', 'Пополнение'),
        ('withdrawal', 'Снятие'),
        ('fee', 'Комиссия'),
    ])
    description = models.TextField()
    status = models.CharField(max_length=20, choices=[
        ('pending', 'Ожидает'),
        ('completed', 'Завершена'),
        ('failed', 'Отклонена'),
        ('cancelled', 'Отменена'),
    ], default='pending')
    created_at = models.DateTimeField(auto_now_add=True)
    completed_at = models.DateTimeField(null=True, blank=True)
```

**Назначение**: Логирование всех финансовых операций.

### Схема базы данных

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│    User     │    │  Operator   │    │   Client    │
│ (Django)    │◄──►│             │◄──►│             │
└─────────────┘    └─────────────┘    └─────────────┘
                           │                   │
                           │                   │
                           ▼                   ▼
                   ┌─────────────┐    ┌─────────────┐
                   │   Service   │    │  BankCard    │
                   │             │    │             │
                   └─────────────┘    └─────────────┘
                           │                   │
                           │                   │
                           ▼                   ▼
                   ┌─────────────┐    ┌─────────────┐
                   │ClientService│    │ Transaction │
                   │             │    │             │
                   └─────────────┘    └─────────────┘
```

---

## API и эндпоинты

### URL маршруты

#### Основные страницы
```python
urlpatterns = [
    path("", views.home, name="home"),
    path("login/", views.login_page, name="login"),
    path("logout/", views.logout_view, name="logout"),
    path("banking-services/", views.banking_services, name="banking_services"),
]
```

#### Дашборды
```python
path("operator1/", views.operator1_dashboard, name="operator1_dashboard"),
path("operator2/", views.operator2_dashboard, name="operator2_dashboard"),
path("client/", views.client_dashboard, name="client_dashboard"),
```

#### Управление услугами
```python
path("create-service-request/", views.create_service_request, name="create_service_request"),
path("connect-service/<int:service_id>/", views.connect_service, name="connect_service"),
path("disconnect-service/<int:service_id>/", views.disconnect_service, name="disconnect_service"),
path("my-services/", views.my_services, name="my_services"),
```

#### Администрирование
```python
path("create-client/", views.create_client, name="create_client"),
path("review-request/<int:request_id>/", views.review_service_request, name="review_service_request"),
path("approve-request/<int:request_id>/", views.approve_service_request, name="approve_service_request"),
path("reject-request/<int:request_id>/", views.reject_service_request, name="reject_service_request"),
```

### Основные представления

#### banking_services
**Назначение**: Каталог банковских услуг с фильтрацией и поиском.

**Параметры**:
- `q`: Поисковый запрос
- `price`: Фильтр по цене (all|free|low|medium|high)
- `sort`: Сортировка (name|price-low|price-high|popular)
- `category`: Фильтр по категории

**Особенности**: Содержит уязвимость SQL-инъекции для демонстрации.

#### client_dashboard
**Назначение**: Панель управления клиента с обзором всех услуг и операций.

**Функции**:
- Просмотр подключенных услуг
- История транзакций
- Управление картами
- Депозиты и кредиты

#### operator1_dashboard
**Назначение**: Панель оператора ДБО #1 для управления клиентами.

**Функции**:
- Создание новых клиентов
- Отправка фишинговых писем
- Управление клиентскими данными

#### operator2_dashboard
**Назначение**: Панель оператора ДБО #2 для валидации заявок.

**Функции**:
- Рассмотрение заявок на услуги
- Одобрение/отклонение заявок
- Анализ безопасности

---

## Безопасность

### Уязвимости для тестирования

#### 1. SQL-инъекция в banking_services
**Расположение**: `dbo/views.py`, функция `banking_services`

**Код уязвимости**:
```python
# ОПАСНО: Прямая конкатенация без параметризации
if q:
    where_clauses.append(f"(s.name LIKE '%{q}%' OR s.description LIKE '%{q}%')")

if category_name:
    where_clauses.append(f"c.name = '{category_name}'")
```

**Эксплойт**:
```sql
-- Поиск: ' OR '1'='1' --
-- Категория: '; DROP TABLE dbo_service; --
```

#### 2. XSS в ServiceRequest
**Расположение**: `dbo/models.py`, поле `service_description`

**Описание**: Поле `service_description` в модели `ServiceRequest` не экранируется при отображении, что позволяет внедрить JavaScript код.

**Эксплойт**:
```html
<script>alert('XSS Attack!')</script>
```

#### 3. Фишинговые атаки
**Расположение**: `dbo/views.py`, функция `phishing_email_view`

**Описание**: Система включает функциональность отправки фишинговых писем для тестирования осведомленности пользователей.

### Меры безопасности

#### 1. Аутентификация и авторизация
- Django User Authentication
- Декораторы `@login_required`
- Проверка ролей пользователей

#### 2. CSRF защита
- Django CSRF middleware
- CSRF токены в формах

#### 3. Логирование атак
- Модель `AttackLog` для записи попыток атак
- Логирование подозрительной активности

#### 4. Валидация данных
- Django Forms для валидации
- Проверка типов данных в моделях

### Рекомендации по безопасности

1. **Исправление SQL-инъекций**:
   - Использовать параметризованные запросы
   - Применять Django ORM вместо сырых SQL запросов

2. **Защита от XSS**:
   - Экранирование HTML в шаблонах
   - Использование `|safe` фильтра только для доверенного контента

3. **Усиление аутентификации**:
   - Двухфакторная аутентификация
   - Ограничение попыток входа

4. **Мониторинг**:
   - Регулярный анализ логов
   - Автоматические уведомления о подозрительной активности

---

## Установка и настройка

### Требования

- Python 3.13+
- Django 5.2.7
- PostgreSQL (для продакшна)
- Node.js (для сборки статических файлов)

### Установка

#### 1. Клонирование репозитория
```bash
git clone <repository-url>
cd dbo
```

#### 2. Создание виртуального окружения
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows
```

#### 3. Установка зависимостей
```bash
pip install -r requirements.txt
```

#### 4. Настройка базы данных
```bash
python manage.py migrate
```

#### 5. Создание суперпользователя
```bash
python manage.py createsuperuser
```

#### 6. Инициализация демо-данных
```bash
python init_data.py
```

#### 7. Запуск сервера разработки
```bash
python manage.py runserver
```

### Конфигурация

#### settings.py
```python
# Основные настройки
DEBUG = True  # Только для разработки!
SECRET_KEY = 'your-secret-key'
ALLOWED_HOSTS = ['localhost', '127.0.0.1']

# База данных
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# Статические файлы
STATIC_URL = '/static/'
STATICFILES_DIRS = [BASE_DIR / 'static']
```

### Переменные окружения

Создайте файл `.env`:
```env
SECRET_KEY=your-secret-key-here
DEBUG=True
DATABASE_URL=sqlite:///db.sqlite3
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-password
```

---

## Администрирование

### Управление пользователями

#### Создание операторов
```python
# Через Django shell
from django.contrib.auth.models import User
from dbo.models import Operator

user = User.objects.create_user('operator1', 'operator1@bank.ru', 'password123')
operator = Operator.objects.create(
    user=user,
    operator_type='client_service',
    email='operator1@bank.ru'
)
```

#### Создание клиентов
```python
from dbo.models import Client

client = Client.objects.create(
    user=user,
    client_id='CLI001',
    full_name='Иван Иванов',
    email='ivan@example.com',
    phone='+7-999-123-45-67'
)
```

### Управление услугами

#### Создание категории услуг
```python
from dbo.models import ServiceCategory, Service

category = ServiceCategory.objects.create(
    name='Расчетно-кассовое обслуживание',
    description='Открытие и ведение расчетных счетов'
)

service = Service.objects.create(
    name='Интернет-банк',
    description='Доступ к банковским услугам через веб-интерфейс',
    category=category,
    price=0,
    is_public=True
)
```

### Мониторинг системы

#### Просмотр логов атак
```python
from dbo.models import AttackLog

# Все атаки
attacks = AttackLog.objects.all()

# Успешные атаки
successful_attacks = AttackLog.objects.filter(success=True)

# Атаки по типу
phishing_attacks = AttackLog.objects.filter(attack_type='phishing')
```

#### Статистика пользователей
```python
from django.contrib.auth.models import User
from dbo.models import Client, Operator

# Общее количество пользователей
total_users = User.objects.count()
total_clients = Client.objects.count()
total_operators = Operator.objects.count()

# Активные пользователи
active_clients = Client.objects.filter(is_active=True).count()
active_operators = Operator.objects.filter(is_active=True).count()
```

### Резервное копирование

#### Создание дампа базы данных
```bash
# SQLite
cp db.sqlite3 backup_$(date +%Y%m%d_%H%M%S).sqlite3

# PostgreSQL
pg_dump -h localhost -U username -d dbo_db > backup_$(date +%Y%m%d_%H%M%S).sql
```

#### Восстановление из резервной копии
```bash
# SQLite
cp backup_20241201_120000.sqlite3 db.sqlite3

# PostgreSQL
psql -h localhost -U username -d dbo_db < backup_20241201_120000.sql
```

---

## Тестирование

### Unit тесты

#### Тестирование моделей
```python
from django.test import TestCase
from dbo.models import Client, Service, ServiceCategory

class ClientModelTest(TestCase):
    def setUp(self):
        self.client = Client.objects.create(
            client_id='TEST001',
            full_name='Тест Тестович',
            email='test@example.com',
            phone='+7-999-999-99-99'
        )
    
    def test_client_creation(self):
        self.assertEqual(self.client.client_id, 'TEST001')
        self.assertEqual(self.client.full_name, 'Тест Тестович')
```

#### Тестирование представлений
```python
from django.test import TestCase, Client
from django.contrib.auth.models import User
from dbo.models import Operator

class BankingServicesViewTest(TestCase):
    def setUp(self):
        self.client = Client()
        self.user = User.objects.create_user('testuser', 'test@example.com', 'password')
        
    def test_banking_services_access(self):
        response = self.client.get('/banking-services/')
        self.assertEqual(response.status_code, 200)
```

### Интеграционные тесты

#### Тестирование SQL-инъекций
```python
def test_sql_injection_protection(self):
    # Тест на SQL-инъекцию в поиске
    malicious_query = "' OR '1'='1' --"
    response = self.client.get(f'/banking-services/?q={malicious_query}')
    
    # Проверяем, что система не падает
    self.assertEqual(response.status_code, 200)
    
    # Проверяем, что данные не скомпрометированы
    self.assertNotContains(response, 'admin')
```

#### Тестирование XSS
```python
def test_xss_protection(self):
    # Тест на XSS в описании услуги
    malicious_script = '<script>alert("XSS")</script>'
    
    # Создаем заявку с XSS
    response = self.client.post('/create-service-request/', {
        'service_name': 'Test Service',
        'service_description': malicious_script,
        'price': 100
    })
    
    # Проверяем, что скрипт экранирован
    self.assertNotContains(response, '<script>')
```

### Нагрузочное тестирование

#### Тестирование производительности
```python
import time
from django.test import TestCase

class PerformanceTest(TestCase):
    def test_banking_services_performance(self):
        start_time = time.time()
        
        # Выполняем запрос
        response = self.client.get('/banking-services/')
        
        end_time = time.time()
        response_time = end_time - start_time
        
        # Проверяем, что ответ получен менее чем за 1 секунду
        self.assertLess(response_time, 1.0)
        self.assertEqual(response.status_code, 200)
```

### Автоматизированное тестирование

#### Настройка CI/CD
```yaml
# .github/workflows/test.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.13
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        python manage.py test
```

---

## Развертывание

### Продакшн настройки

#### settings.py для продакшна
```python
import os

# Безопасность
DEBUG = False
SECRET_KEY = os.environ.get('SECRET_KEY')
ALLOWED_HOSTS = ['yourdomain.com', 'www.yourdomain.com']

# База данных PostgreSQL
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.environ.get('DB_NAME'),
        'USER': os.environ.get('DB_USER'),
        'PASSWORD': os.environ.get('DB_PASSWORD'),
        'HOST': os.environ.get('DB_HOST'),
        'PORT': os.environ.get('DB_PORT'),
    }
}

# Статические файлы
STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')

# Медиа файлы
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# Безопасность
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
X_FRAME_OPTIONS = 'DENY'
SECURE_HSTS_SECONDS = 31536000
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True
```

### Docker развертывание

#### Dockerfile
```dockerfile
FROM python:3.13-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

RUN python manage.py collectstatic --noinput

EXPOSE 8000

CMD ["gunicorn", "cyberpolygon.wsgi:application", "--bind", "0.0.0.0:8000"]
```

#### docker-compose.yml
```yaml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DEBUG=False
      - SECRET_KEY=your-secret-key
      - DB_NAME=dbo_db
      - DB_USER=dbo_user
      - DB_PASSWORD=dbo_password
      - DB_HOST=db
    depends_on:
      - db

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=dbo_db
      - POSTGRES_USER=dbo_user
      - POSTGRES_PASSWORD=dbo_password
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

### Nginx конфигурация

#### nginx.conf
```nginx
server {
    listen 80;
    server_name yourdomain.com;

    location /static/ {
        alias /app/staticfiles/;
    }

    location /media/ {
        alias /app/media/;
    }

    location / {
        proxy_pass http://web:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### SSL сертификаты

#### Let's Encrypt
```bash
# Установка certbot
sudo apt-get install certbot python3-certbot-nginx

# Получение сертификата
sudo certbot --nginx -d yourdomain.com

# Автоматическое обновление
sudo crontab -e
# Добавить: 0 12 * * * /usr/bin/certbot renew --quiet
```

### Мониторинг

#### Логирование
```python
# settings.py
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': 'logs/dbo.log',
        },
    },
    'loggers': {
        'dbo': {
            'handlers': ['file'],
            'level': 'INFO',
            'propagate': True,
        },
    },
}
```

#### Мониторинг производительности
```python
# Установка django-debug-toolbar для разработки
INSTALLED_APPS = [
    'debug_toolbar',
    # ... другие приложения
]

MIDDLEWARE = [
    'debug_toolbar.middleware.DebugToolbarMiddleware',
    # ... другие middleware
]
```

---

## Заключение

Система ДБО "ФинансПро" представляет собой комплексное решение для дистанционного банковского обслуживания с современной архитектурой и широкими возможностями настройки. Система включает в себя все необходимые компоненты для полноценного банковского сервиса и может быть легко адаптирована под конкретные требования.

### Основные преимущества

- **Масштабируемость**: Архитектура позволяет легко добавлять новые функции
- **Безопасность**: Многоуровневая система защиты с возможностью тестирования уязвимостей
- **Гибкость**: Модульная структура упрощает кастомизацию
- **Производительность**: Оптимизированные запросы и кэширование

### Планы развития

1. **Мобильное приложение**: Разработка React Native приложения
2. **API**: Создание REST API для интеграции с внешними системами
3. **Аналитика**: Система бизнес-аналитики и отчетности
4. **ИИ**: Интеграция машинного обучения для обнаружения мошенничества

### Поддержка

Для получения технической поддержки обращайтесь:
- **Email**: support@finanspro.ru
- **Документация**: https://docs.finanspro.ru
- **GitHub**: https://github.com/finanspro/dbo

---

**© 2024 Система ДБО "ФинансПро". Все права защищены.**
