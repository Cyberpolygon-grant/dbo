Устранение уязвимости осуществить путём добавления параметризованных запросов для защиты от SQL-инъекции и проверки прав доступа для защиты от IDOR.

Следует отметить, что индикатор устранения уязвимости не изменится, пока не будет устранено последствие в виде вредоносного соединения. Рекомендации по закрытию вредоносного соединения представлены в соответствующем описании (Подраздел 3.3).

3.2.1 Обновление: Добавить параметризованные запросы и проверку прав доступа

Данная уязвимость исправлена путём замены прямых SQL-запросов с конкатенацией строк на параметризованные запросы и добавления проверки прав доступа в функции подключения услуг. Для исправления уязвимости необходимо внести изменения в файлы приложения.

**Исправление в функции `banking_services`:**

Данная функция используется для отображения каталога банковских услуг. Ранее использовались прямые SQL-запросы с конкатенацией строк, что позволяло внедрять произвольный SQL-код.

• **Было (небезопасно):**
```python
where_clauses.append(f"c.name = '{category_name}'")  # SQL-инъекция!
where_clauses.append(f"(s.name LIKE '%{q}%' OR s.description LIKE '%{q}%')")  # SQL-инъекция!
sql = f"SELECT ... WHERE {' AND '.join(where_clauses)}"
cursor.execute(sql)
```

• **Стало (безопасно):**
```python
sql_parts.append("AND c.name = %s")  # Параметризованный запрос
params.append(category_name)
sql_parts.append("AND (s.name LIKE %s OR s.description LIKE %s)")
params.extend([f'%{q}%', f'%{q}%'])
sql = " ".join(sql_parts)
cursor.execute(sql, params)  # Параметры передаются вторым аргументом
```

Параметризованные запросы автоматически экранируют все специальные символы SQL, предотвращая выполнение произвольного SQL-кода. Параметры передаются вторым аргументом в `cursor.execute()`, что гарантирует их безопасную обработку базой данных.

**Исправление в функции `connect_service`:**

Данная функция используется для подключения услуг. Ранее отсутствовала проверка прав доступа, что позволяло подключать любые услуги, включая служебные.

• **Было (небезопасно):**
```python
service = Service.objects.get(uuid=service_uuid, is_active=True)
# Нет проверки прав доступа - можно подключить любую услугу
ClientService.objects.create(client=client, service=service, ...)
```

• **Стало (безопасно):**
```python
service = Service.objects.get(uuid=service_uuid, is_active=True)
# Проверка прав доступа
if service.category.name == 'Служебные' and not request.user.is_staff:
    return JsonResponse({'success': False, 'error': 'Доступ запрещен'})
ClientService.objects.create(client=client, service=service, ...)
```

Проверка категории услуги перед подключением предотвращает подключение служебных услуг обычными пользователями.

**Местоположение файлов для исправления:**

Файлы находятся в директории проекта:
• `dbo/views.py` (строки 43-113 для функции `banking_services`, строки 347-443 для функции `connect_service`)

**Порядок действий для исправления:**

1. Открыть файл `dbo/views.py` в текстовом редакторе или IDE.

2. Найти функцию `banking_services` (примерно строка 43) и заменить построение SQL-запроса с использованием f-строк на параметризованные запросы:
   - Заменить `where_clauses.append(f"c.name = '{category_name}'")` на `sql_parts.append("AND c.name = %s")` и `params.append(category_name)`
   - Заменить `where_clauses.append(f"(s.name LIKE '%{q}%' ...)")` на `sql_parts.append("AND (s.name LIKE %s OR s.description LIKE %s)")` и `params.extend([f'%{q}%', f'%{q}%'])`
   - Заменить `cursor.execute(sql)` на `cursor.execute(sql, params)`

3. Найти функцию `connect_service` (примерно строка 347) и добавить проверку прав доступа после получения услуги:
   ```python
   if service.category.name == 'Служебные' and not request.user.is_staff:
       return JsonResponse({'success': False, 'error': 'Доступ запрещен'})
   ```

4. Сохранить изменения и перезапустить веб-сервер:
   ```bash
   docker compose restart app
   ```

**Проверка исправления:**

После внесения изменений необходимо проверить, что уязвимость устранена:

1. Попытка SQL-инъекции в поле поиска: ввести `' OR '1'='1` или `' UNION SELECT ...--` и убедиться, что запрос обрабатывается безопасно, а не выполняется как SQL-код.

2. Попытка подключения служебной услуги: использовать UUID служебной услуги (если известен) в запросе к `/connect-service/<uuid>/` и убедиться, что запрос отклоняется с сообщением об ошибке доступа.

3. Просмотр логов gunicorn (`/app/logs/gunicorn-access.log`) и убедиться, что SQL-код в запросах экранируется, а попытки подключения служебных услуг блокируются.

**4. Обнаружение и нейтрализация полезных нагрузок**

Уязвимый узел позволяет реализовать подключение служебных услуг к учетной записи злоумышленника без соответствующих прав доступа.

4.1 Отключение подключенных служебных услуг

Данная полезная нагрузка подразумевает подключение служебных услуг, которые должны быть доступны только администраторам и операторам системы.

Подключенные служебные услуги у злоумышленника будут отображаться в разделе "Мои услуги":

Для нейтрализации данной полезной нагрузки необходимо:

1. Войти в систему как администратор или оператор ДБО #1

2. Перейти в раздел управления клиентами и найти учетную запись злоумышленника

3. Просмотреть список подключенных услуг клиента и найти служебные услуги

4. Отключить служебные услуги через административную панель или напрямую в базе данных:
   ```sql
   UPDATE dbo_clientservice 
   SET status = 'cancelled', is_active = false 
   WHERE client_id = <ID_клиента> 
   AND service_id IN (SELECT id FROM dbo_service WHERE category_id IN (SELECT id FROM dbo_servicecategory WHERE name LIKE '%Служебные%'));
   ```

5. Проверить, что служебные услуги больше не отображаются в разделе "Мои услуги" у злоумышленника

6. При необходимости заблокировать учетную запись злоумышленника для предотвращения повторной атаки

