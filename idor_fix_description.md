**3.2.2 Добавление проверки прав доступа**

Данная уязвимость исправлена путём добавления проверки прав доступа в функции подключения услуг. Для исправления уязвимости необходимо внести изменения в файлы приложения.

**Исправление в функции `connect_service` в файле `views.py`:**

Данная функция используется для подключения услуг к учетной записи клиента. Ранее отсутствовала проверка прав доступа, что позволяло подключать любые услуги, включая служебные, доступ к которым должен быть ограничен только для администраторов и операторов системы.

• **Было (небезопасно):**
```python
service = Service.objects.get(uuid=service_uuid, is_active=True)
# Нет проверки прав доступа - можно подключить любую услугу
ClientService.objects.create(client=client, service=service, ...)
```

• **Стало (безопасно):**
```python
service = Service.objects.get(uuid=service_uuid, is_active=True)
# Проверка прав доступа
if service.category.name == 'Служебные' and not (request.user.is_staff or request.user.is_superuser):
    return JsonResponse({'success': False, 'error': 'Доступ запрещен: служебные услуги доступны только администраторам'})
ClientService.objects.create(client=client, service=service, ...)
```

Проверка категории услуги перед подключением предотвращает подключение служебных услуг обычными пользователями. Если пользователь пытается подключить служебную услугу и не является администратором или суперпользователем, запрос отклоняется с сообщением об ошибке доступа.

**Местоположение файлов для исправления:**

Файлы находятся в директории проекта:
• `dbo/views.py` (строки 347-443 для функции `connect_service`)

**Порядок действий для исправления:**

1. Открыть файл `dbo/views.py` в текстовом редакторе или IDE.

2. Найти функцию `connect_service` (примерно строка 347) и добавить проверку прав доступа после получения услуги, но перед созданием записи `ClientService`:
   ```python
   # Проверка прав доступа
   if service.category.name == 'Служебные' and not (request.user.is_staff or request.user.is_superuser):
       return JsonResponse({'success': False, 'error': 'Доступ запрещен: служебные услуги доступны только администраторам'})
   ```

3. Сохранить изменения и перезапустить веб-сервер:
   ```bash
   docker compose restart app
   ```

**Проверка исправления:**

После внесения изменений необходимо проверить, что уязвимость устранена:

1. Попытка подключения служебной услуги: использовать UUID служебной услуги (если известен) в запросе к `/connect-service/<uuid>/` и убедиться, что запрос отклоняется с сообщением об ошибке доступа.

2. Проверка для администратора: убедиться, что администраторы и операторы системы могут подключать служебные услуги без ограничений.

3. Просмотр логов gunicorn (`/app/logs/gunicorn-access.log`) и убедиться, что попытки подключения служебных услуг обычными пользователями блокируются.

