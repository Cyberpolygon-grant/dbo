# Запуск проекта в Docker Compose

## Быстрый старт

Все действия из `up.sh` встроены в Docker Compose! Просто запустите:

```bash
docker compose up -d
```

Docker Compose автоматически:
- ✅ Создаст `.env` из `env.sample` если его нет (через init-env контейнер)
- ✅ Определит Django модуль (cyberpolygon)
- ✅ Настроит переменные окружения
- ✅ Дождется готовности PostgreSQL
- ✅ Запустит миграции
- ✅ Соберет статические файлы
- ✅ Запустит Gunicorn с оптимизированными настройками

Проверьте логи:
```bash
docker compose logs -f app
```

**Важно:** Отредактируйте `.env` после первого запуска и установите `SECRET_KEY`!

## Что было настроено

### PostgreSQL
- Используется PostgreSQL 16 (Alpine образ для меньшего размера)
- Настроены параметры производительности для лучшей работы
- Автоматическое создание базы данных при первом запуске

### Gunicorn
- Настроен Gunicorn с 4 воркерами для лучшей производительности
- Автоматический перезапуск воркеров после 1000 запросов
- Таймауты и keep-alive настроены для стабильной работы

### Автоматизация (вся логика из up.sh встроена)
- **init-env контейнер**: Автоматически создает `.env` из `env.sample` если отсутствует
- **Автоматическое определение Django модуля**: Entrypoint определяет модуль по наличию `wsgi.py`
- **Автоматическая настройка `ALLOWED_HOSTS`**: По умолчанию включает localhost, 127.0.0.1, 172.18.252.50
- **Автоматические миграции**: Выполняются при каждом запуске контейнера
- **Опциональная инициализация демо-данных**: Через переменную `INIT_DATA=1`

### Оптимизации
- Ожидание готовности базы данных перед запуском приложения
- Автоматические миграции при запуске
- Сбор статических файлов
- Использование connection pooling для PostgreSQL
- Настроена сеть между контейнерами

## Команды

- **Запуск**: `docker compose up -d` (все настройки автоматические!)
- **Остановка**: `docker compose down`
- **Просмотр логов**: `docker compose logs -f app`
- **Пересборка**: `docker compose up -d --build`
- **Выполнение команд в контейнере**: `docker compose exec app python manage.py <command>`
- **Инициализация демо-данных**: `docker compose exec app python init_data.py`
- **Проверка статуса**: `docker compose ps`

## Инициализация демо-данных

Для автоматической инициализации демо-данных при первом запуске:

1. Установите в `.env`:
```bash
INIT_DATA=1
```

2. Перезапустите контейнер:
```bash
docker compose restart app
```

Или выполните вручную:
```bash
docker compose exec app python init_data.py
```

## Переменные окружения

Основные переменные в `.env`:
- `POSTGRES_DB` - имя базы данных
- `POSTGRES_USER` - пользователь PostgreSQL
- `POSTGRES_PASSWORD` - пароль PostgreSQL
- `SECRET_KEY` - секретный ключ Django (обязательно!)
- `DEBUG` - режим отладки (0 или 1)
- `ALLOWED_HOSTS` - разрешенные хосты (по умолчанию: localhost,127.0.0.1,172.18.252.50)
- `DJANGO_SETTINGS_MODULE` - модуль настроек Django (автоматически определяется)
- `DJANGO_WSGI_MODULE` - WSGI модуль (автоматически определяется)
- `INIT_DATA` - инициализация демо-данных (0 или 1, по умолчанию 0)

