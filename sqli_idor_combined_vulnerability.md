# Уязвимость № 1

## Описание уязвимости

Комбинированная уязвимость SQL Injection и IDOR (Insecure Direct Object Reference) на странице каталога банковских услуг в системе ДБО. SQL Injection позволяет внедрять произвольный SQL-код в параметры поиска (`q`, `category`, `sort`), что приводит к несанкционированному доступу к данным и обнаружению служебных услуг, скрытых от обычных пользователей через фильтр `exclude(name__icontains='Служебные')`. В сочетании с уязвимостью IDOR в функции подключения услуг `/connect-service/<service_uuid>/`, злоумышленник может использовать найденные через SQL-инъекцию UUID служебных услуг для их подключения к своей учетной записи, доступ к которым должен быть ограничен только для администраторов и операторов системы.

## Условия эксплуатации уязвимости

– Доступ к системе ДБО (наличие учетной записи клиента)

## Способы обнаружения эксплуатации уязвимости

Обнаружение уязвимости SQL Injection возможно:

- в WAF во разделе Attacks в разделе Logs

- в логах gunicorn по пути: `/app/logs/gunicorn-access.log` должен быть зафиксирован GET-запрос к `/banking-services/` с параметрами, содержащими SQL-код (например, `q=' OR '1'='1`, `category=' UNION SELECT s.id, s.name, s.description, s.price, s.is_active, s.rating, s.rating_count, c.name, s.uuid FROM dbo_service s JOIN dbo_servicecategory c ON s.category_id = c.id WHERE c.name LIKE '%Служебные%'--`, `sort=name; SELECT uuid FROM dbo_service WHERE category_id IN (SELECT id FROM dbo_servicecategory WHERE name LIKE '%Служебные%')--`)

- в логах gunicorn должен быть зафиксирован POST-запрос к `/connect-service/<uuid>/` с UUID служебной услуги, который был получен через SQL-инъекцию

Средства обнаружения вторжений: ViPNet IDS NS и Security Onion обнаруживают в сетевом трафике SQL-код, предназначенный для эксплуатации уязвимости SQL Injection (например, операторы `UNION`, `SELECT`, `WHERE`, комментарии `--` и `/* */`), а также необычные запросы на подключение услуг с UUID, которые не должны быть доступны обычным пользователям.

## Способы закрытия уязвимости

- Модификация запроса к базе данных, в который подставляются значения из фильтра всех услуг, использование параметризованных запросов вместо конкатенации строк

- Добавление проверки прав доступа в функции `connect_service` для предотвращения подключения служебных услуг обычными пользователями (проверка категории услуги перед подключением)

## Способ проверки статуса уязвимости

Внутренняя проверка статуса уязвимости:

- Ввод в поле для поиска услуг SQL-синтаксиса, например: `' UNION SELECT s.id, s.name, s.description, s.price, s.is_active, s.rating, s.rating_count, c.name, s.uuid FROM dbo_service s JOIN dbo_servicecategory c ON s.category_id = c.id WHERE c.name LIKE '%Служебные%'--`

- Использование SQL-инъекции для получения списка служебных услуг вместе с их UUID через параметр `category` или прямой SQL-запрос

- Попытка подключения найденной служебной услуги через POST-запрос к `/connect-service/<uuid>/` с UUID служебной услуги, полученным через SQL-инъекцию

## Полезные нагрузки

Подключение служебных услуг к учетной записи злоумышленника, которые должны быть доступны только администраторам или операторам системы (например, услуги категории "Служебные", которые предоставляют расширенные права доступа или привилегированные функции). Эксплуатация происходит в два этапа: сначала SQL-инъекция для обнаружения UUID служебных услуг, затем использование найденных UUID для их подключения через уязвимость IDOR.

